---
title:  "ì¤‘ê¸‰ ë¬¸ë²•"
excerpt: "Projections, ë™ì  ì¿¼ë¦¬, ë²Œí¬ì—°ì‚°, SQL function í˜¸ì¶œí•˜ê¸°"
date:   2021-10-26 19:30:00
header:
  teaser: /assets/images/spring.png

categories: QueryDSL
tags:
  - Java
  - Spring
  - JPA
  - QueryDSL
  - Projections
last_modified_at: 2021-10-26T19:30:00

---

<br/>

## ğŸ’¡ í”„ë¡œì ì…˜

##### í”„ë¡œì ì…˜ì€ select ëŒ€ìƒì„ ì§€ì •í•˜ëŠ” ê²ƒì´ë‹¤.

<br/>

##### í”„ë¡œì ì…˜ ëŒ€ìƒì´ í•˜ë‚˜ì¸ ê²½ìš°

```java
List result = queryFactory 
    		.select(member.username) 
    		.from(member) 
    		.fetch();
```

- ##### í”„ë¡œì ì…˜ ëŒ€ìƒì´ í•˜ë‚˜ì´ë©´ íƒ€ì…ì„ ëª…í™•í•˜ê²Œ ì§€ì •í•  ìˆ˜ ìˆë‹¤

- ##### í”„ë¡œì ì…˜ ëŒ€ìƒì´ ë‘˜ ì´ìƒì´ë©´ íŠœí”Œì´ë‚˜ DTOë¡œ ì¡°íšŒí•œë‹¤.

<br/>

<br/>

### ğŸ¬ íŠœí”Œ ì¡°íšŒ

```java
List<Tuple> result = queryFactory
 	 				 .select(member.username, member.age)
					 .from(member)
 					 .fetch();

for (Tuple tuple : result) {
	 String username = tuple.get(member.username);
	 Integer age = tuple.get(member.age);
 	 System.out.println("username=" + username);
	 System.out.println("age=" + age);
}
```

<br/>

<br/>

## ğŸ¬ Querydsl ë¹ˆ ìƒì„±(Bean population)

##### ê²°ê³¼ë¥¼ DTOë¡œ ë°˜í™˜í•  ë–„ ì‚¬ìš©í•˜ë©°, 3ê°€ì§€ ë°©ë²•ì„ ì§€ì›í•œë‹¤.

- ##### í”„ë¡œí¼í‹° ì ‘ê·¼

- ##### í•„ë“œ ì§ì ‘ ì ‘ê·¼

- ##### ìƒì„±ì ì‚¬ìš©

<br/>

#### ğŸ” í”„ë¡œí¼í‹° ì ‘ê·¼ë²•(Setter)

```java
List<MemberDto> result = queryFactory
 	.select(Projections.bean(MemberDto.class,
 			member.username,
 			member.age))
 	.from(member)
 	.fetch();
```

<br/>

#### ğŸ” í•„ë“œ ì§ì ‘ ì ‘ê·¼

```java
List<MemberDto> result = queryFactory
 	.select(Projections.fields(MemberDto.class,
 		member.username,
 		member.age))
 	.from(member)
 	.fetch();
```

<br/>

#### ì°¸ê³ - ë³„ì¹­ì´ ë‹¤ë¥¼ ë•Œ

```java
List<UserDto> fetch = queryFactory
 	.select(Projections.fields(UserDto.class,
		 member.username.as("name"),
 		ExpressionUtils.as(
 		JPAExpressions
 			.select(memberSub.age.max())
 			.from(memberSub), "age")
 			)
 		).from(member)
 	.fetch();
```



##### ExpressionUtils.as(source,alias) : í•„ë“œë‚˜, ì„œë¸Œ ì¿¼ë¦¬ì— ë³„ì¹­ ì ìš© 

##### username.as("memberName") : í•„ë“œì— ë³„ì¹­ ì ìš©

<br/>

<br/>

### ğŸ” ìƒì„±ì ì ‘ê·¼

#### com.querydsl.core.types.Projections ì‚¬ìš©

<br/>

```java
List<MemberDto> result = queryFactory
 		.select(Projections.constructor(MemberDto.class,
 			member.username,
 			member.age))
 		.from(member)
 	.fetch();
}
```

<br/>

<br/>

## ğŸ¬ @QueryProjection

##### ìƒì„±ì + @QueryProjection

```java
@Data
public class MemberDto {
 	private String username;
 	private int age;
 	public MemberDto() {
 	}
 	
 	@QueryProjection //ì¤‘ìš”
 	public MemberDto(String username, int age) {
 		this.username = username;
 		this.age = age;
 	}
}
```

##### ìƒì„±ìì— @QueryProjectionë¥¼ ì ìš©í•œ ë’¤ compileQuerydslì„ í•´ì£¼ì

##### DTOë„ QíŒŒì¼ë¡œ ìƒì„±ì´ ëœë‹¤

<br/>

```java
List<MemberDto> result = queryFactory
 	.select(new QMemberDto(member.username, member.age))
 	.from(member)
 	.fetch();
```

##### ì´ ë°©ë²•ì€ ì»´íŒŒì¼ëŸ¬ë¡œ íƒ€ì…ì„ ì²´í¬í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ì´ë‹¤. 

##### ë‹¤ë§Œ DTOì— QueryDSL ì–´ë…¸í…Œì´ì…˜ì„ ìœ ì§€í•´ì•¼ í•˜ëŠ” ì ê³¼ DTOê¹Œì§€ Q íŒŒì¼ì„ ìƒì„±í•´ì•¼ í•˜ëŠ” ë‹¨ì ì´ ìˆë‹¤

<br/>

<br/>

## ğŸ’¡ ë™ì  ì¿¼ë¦¬

### ğŸ¬ BooleanBuilder ì‚¬ìš©

```java
@Test
public void ë™ì ì¿¼ë¦¬_BooleanBuilder() throws Exception {
 	String usernameParam = "member1";
 	Integer ageParam = 10;
 	List<Member> result = searchMember1(usernameParam, ageParam);
 	Assertions.assertThat(result.size()).isEqualTo(1);
}

private List<Member> searchMember1(String usernameCond, Integer ageCond) {
    
    //ì¡°ê±´ì˜ í•„ìˆ˜ê°’ì„ ë„£ì„ ìˆ˜ ìˆìŒ
 	BooleanBuilder builder = new BooleanBuilder(/**member.username.eq(usernameCond)*/);
    
 	if (usernameCond != null) {
 		builder.and(member.username.eq(usernameCond));
 	}
    
 	if (ageCond != null) {
 		builder.and(member.age.eq(ageCond));
	 }
    
 	return queryFactory
 		.selectFrom(member)
 		.where(builder)
 		.fetch();
}
```

<br/>

<br/>

<br/>

<br/>

### ğŸ¬ whereì— ë‹¤ì¤‘ íŒŒë¼ë¯¸í„° ì‚¬ìš©

```java
@Test
public void ë™ì ì¿¼ë¦¬_WhereParam() throws Exception {
 	String usernameParam = "member1";
 	Integer ageParam = 10;
 	List<Member> result = searchMember2(usernameParam, ageParam);
 	Assertions.assertThat(result.size()).isEqualTo(1);
}

private List<Member> searchMember2(String usernameCond, Integer ageCond) {
 	return queryFactory
 		.selectFrom(member)
 		.where(usernameEq(usernameCond), ageEq(ageCond))
 		.fetch();
}

private BooleanExpression usernameEq(String usernameCond) {
 	return usernameCond != null ? member.username.eq(usernameCond) : null;
}
private BooleanExpression ageEq(Integer ageCond) {
 	return ageCond != null ? member.age.eq(ageCond) : null;
}
```

- ##### where ì¡°ê±´ì— null ê°’ì€ ë¬´ì‹œëœë‹¤. 

- ##### ë©”ì„œë“œë¥¼ ë‹¤ë¥¸ ì¿¼ë¦¬ì—ì„œë„ ì¬í™œìš© í•  ìˆ˜ ìˆë‹¤. 

- ##### ì¿¼ë¦¬ ìì²´ì˜ ê°€ë…ì„±ì´ ë†’ì•„ì§„ë‹¤.

<br/>

#### ì¡°í•© ê°€ëŠ¥ 

```java
private BooleanExpression allEq(String usernameCond, Integer ageCond) {
	return usernameEq(usernameCond).and(ageEq(ageCond));
} 
```

##### null ì²´í¬ëŠ” ì£¼ì˜í•´ì„œ ì²˜ë¦¬í•´ì•¼í•¨

<br/>

<br/>

<br/>

## ğŸ’¡ ë²Œí¬ ì—°ì‚°

```java
long count = queryFactory 
	.update(member) 
	.set(member.username, "ë¹„íšŒì›") 
	.where(member.age.lt(28)) 
	.execute();
```

##### ì‚­ì œëŠ” delete ì‚¬ìš©

<br/>

#### ì£¼ì˜

##### JPQL ë°°ì¹˜ì™€ ë§ˆì°¬ê°€ì§€ë¡œ, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìˆëŠ” ì—”í‹°í‹°ë¥¼ ë¬´ì‹œí•˜ê³  ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— ë°°ì¹˜ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ë‚˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•˜ëŠ” ê²ƒì´ ì•ˆì „í•˜ë‹¤

<br/>

<br/>

<br/>

## ğŸ’¡ SQL function í˜¸ì¶œí•˜ê¸°

##### SQL functionì€ JPAì™€ ê°™ì´ Dialectì— ë“±ë¡ëœ ë‚´ìš©ë§Œ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤. 

##### member Mìœ¼ë¡œ ë³€ê²½í•˜ëŠ” replace í•¨ìˆ˜ ì‚¬ìš© 

```java
String result = queryFactory 
				.select(Expressions.stringTemplate("function('replace', {0}, {1}, {2})", member.username, "member", "M")) 
				.from(member) 
				.fetchFirst(); 
```

<br/>

##### ì†Œë¬¸ìë¡œ ë³€ê²½í•´ì„œ ë¹„êµí•´ë¼.

```java
.select(member.username) 
.from(member) 
.where(member.username.eq(Expressions.stringTemplate("function('lower', {0})", member.username))) 
```

<br/>

##### lower ê°™ì€ ansi í‘œì¤€ í•¨ìˆ˜ë“¤ì€ querydslì´ ìƒë‹¹ë¶€ë¶„ ë‚´ì¥í•˜ê³  ìˆë‹¤. ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì²˜ë¦¬í•´ë„ ê²°ê³¼ëŠ” ê°™ë‹¤. 

```java
.where(member.username.eq(member.username.lower()))
```

<br/>

<br/>

### ğŸ“” Reference

[ì‹¤ì „! Querydsl](https://www.inflearn.com/course/Querydsl-%EC%8B%A4%EC%A0%84/dashboard)

