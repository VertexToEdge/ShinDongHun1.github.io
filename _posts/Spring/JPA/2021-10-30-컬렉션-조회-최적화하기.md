---
title:  "ì»¬ë ‰ì…˜ ì¡°íšŒ ìµœì í™”í•˜ê¸°"
excerpt: "ì¿¼ë¦¬ ìˆ˜ ìµœì í™” ì‹œë„"
date:   2021-10-30 00:30:00
header:
  teaser: /assets/images/spring.png

categories: JPA
tags:
  - Java
  - Spring
  - JPA
  - QueryDSL
  - N+1 ë¬¸ì œ
  - JPA
last_modified_at: 2021-10-30T00:30:00


---

## ì¿¼ë¦¬ ìˆ˜ ìµœì í™”ì— ëŒ€í•´ì„œ

##### í•œ 3ì¼..?ë™ì•ˆ ì •ë§ í•˜ë£¨ì¢…ì¼ ì´ê²ƒë§Œ í–ˆë‹¤. ë„ˆë¬´ ì–´ë ¤ì› ê³ , ì ‘ê·¼ì¡°ì°¨ í•˜ê¸°ê°€ ì–´ë ¤ì› ë‹¤.

##### ìš°ì„  ìµœì í™” í•  ì—”í‹°í‹°ë“¤ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ê² ë‹¤

<br/>

#### BBS - Post, Comment, ReComment ëª¨ë‘ ìƒì†í•˜ê³  ìˆëŠ”, ë¶€ëª¨ í´ë˜ìŠ¤

<script src="https://gist.github.com/ShinDongHun1/3420c56b9c98db9bcc65321593064bc2.js"></script>

##### Memberì™€ N : 1 ì—°ê´€ê´€ê³„ë¥¼ ê°€ì§„ë‹¤

##### UploadFileê³¼ 1 : N ì—°ê´€ê´€ê³„ë¥¼ ê°€ì§€ë©°, íŠ¹ë³„íˆ BBS ê°€ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì—ˆë‹¤.

##### LikedBBS : MemberëŠ” ì—¬ëŸ¬ BBSì— ëŒ€í•´ì„œ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¼ ìˆ˜ ìˆê³ , BBSëŠ” ì—¬ëŸ¬ Memberì— ëŒ€í•´ì„œ ì¢‹ì•„ìš”ê°€ ëˆŒë ¤ì§ˆ ìˆ˜ ìˆë‹¤. ì¦‰ N : N ê´€ê³„ì—¬ì„œ ì´ ê´€ê³„ë¥¼ 1 : Nê³¼ N : 1 ì˜ ê´€ê³„ë¡œ í’€ì–´ ì¤„ ì¤‘ê°„ì—”í‹°í‹°ì¸ LikedBSSë¥¼ ë§Œë“¤ì—ˆë‹¤.

<br/><br/>

#### UploadFile

<script src="https://gist.github.com/ShinDongHun1/0cf63a67e77e937a47b1ef97184e22c4.js"></script>

##### ë‹¨ìˆœí•˜ë‹¤, Stringìœ¼ë¡œ íŒŒì¼ì´ ì €ì¥ëœ ê²½ë¡œë§Œ ê°€ì§€ê³ ìˆë‹¤.

<br/>

<br/>

#### Post

<script src="https://gist.github.com/ShinDongHun1/10f080f3a68bdb17387e5f5f0be38f6c.js"></script>

##### views : ì¡°íšŒìˆ˜ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤

##### CommentList : ëŒ“ê¸€ë“¤ì˜ ëª©ë¡

<br/>

<br/>

#### Comment

<script src="https://gist.github.com/ShinDongHun1/96045290647aab39ef096eafe429f62a.js"></script>

<br/>

<br/>

#### ReComment

<script src="https://gist.github.com/ShinDongHun1/118d124162476e92c8778949ad790a77.js"></script>

<br/>

<br/>

##### ìœ„ì™€ ê°™ì´ ì—”í‹°í‹°ë“¤ì„ ì„¤ì •í•´ì£¼ì—ˆë‹¤.

##### ì •ë¦¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

##### 1. ê²Œì‹œë¬¼(Post)ì—ëŠ” ì—¬ëŸ¬ ëŒ“ê¸€(Comment)ë“¤ì´ ë‹¬ë¦´ ìˆ˜ ìˆê³ , ê°ê°ì˜ ëŒ“ê¸€ë“¤ì—ëŠ” ì—¬ëŸ¬ê°œì˜ ëŒ€ëŒ“ê¸€(ReComment)ê°€ ë‹¬ë¦´ ìˆ˜ ìˆë‹¤.

##### 2. ê²Œì‹œë¬¼ê³¼, ëŒ“ê¸€, ëŒ€ëŒ“ê¸€ì€ ëª¨ë‘ ì‘ì„±ì(Member)ì™€, ì—…ë¡œë“œí•œ íŒŒì¼(UploadFile)ë“¤ì˜ ëª©ë¡ì„ ê°€ì§€ê³  ìˆë‹¤.

<br/>

##### ìœ„ì™€ ê°™ì€ ìƒí™©ì—ì„œ ë‚˜ëŠ” ë‹¤ìŒê³¼ ê°™ì´ í¬ìŠ¤íŠ¸ë¥¼ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•  ê²ƒì´ë‹¤.

##### í¬ìŠ¤íŠ¸ì˜ idë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ í¬ìŠ¤íŠ¸ì˜ ì •ë³´ë¥¼ REST API ë°©ì‹ìœ¼ë¡œ ì „ì†¡.

<br/>

### í¬ìŠ¤íŠ¸ì˜ ì •ë³´

> ##### í¬ìŠ¤íŠ¸ì˜ id
>
> ##### í¬ìŠ¤íŠ¸ì˜ ë‚´ìš©
>
> ##### í¬ìŠ¤íŠ¸ì˜ ì¢‹ì•„ìš” ìˆ˜     => likedBBSList.size()  => ì¶”ê°€ì¿¼ë¦¬ ë°œìƒ
>
> ##### í¬ìŠ¤íŠ¸ì˜ ì¡°íšŒ ìˆ˜
>
> ##### í¬ìŠ¤íŠ¸ì˜ ì—­í• 
>
> 
>
> ##### í¬ìŠ¤íŠ¸ì˜ ì‘ì„±ì id     => MemberëŠ” ì—”í‹°í‹°ì´ë¯€ë¡œ ê°€ì ¸ì˜¬ ë•Œ ì¶”ê°€ì¿¼ë¦¬ ë°œìƒ (íŒ¨ì¹˜ì¡°ì¸ìœ¼ë¡œ í•´ê²° ê°€ëŠ¥)
>
> ##### í¬ìŠ¤íŠ¸ì˜ ì‘ì„±ì ì´ë¦„
>
> ##### í¬ìŠ¤íŠ¸ì˜ ì‘ì„±ì username
>
> ##### í¬ìŠ¤íŠ¸ì— ë“±ë¡í•œ íŒŒì¼ë“¤ì˜ ê²½ë¡œ   => UploadFileë„ ì—”í‹°í‹°ì´ë¯€ë¡œ ì¶”ê°€ì¿¼ë¦¬ ë°œìƒ, ì»¬ë ‰ì…˜ì´ë¼ í˜ì¹˜ì¡°ì¸ X
>
> ##### 																(ë°°ì¹˜ì‚¬ì´ì¦ˆë¡œ ìµœì í™”ê°€ëŠ¥) 
>
> 
>
> ##### í¬ìŠ¤íŠ¸ì— ë‹¬ë ¤ìˆëŠ” ëŒ“ê¸€ë“¤ ì •ë³´[ => ë‹¹ì—°í•˜ê²Œë„ ì¶”ê°€ì¿¼ë¦¬ ë°œìƒ(ë°°ì¹˜ì‚¬ì´ì¦ˆë¡œ ìµœì í™”)
>
> ##### 	ëŒ“ê¸€ì˜ id
>
> ##### 	ëŒ“ê¸€ì˜ ë‚´ìš©
>
> ##### 	ëŒ“ê¸€ì˜ ì¢‹ì•„ìš” ìˆ˜ => likedBBSList.size()  => ì¶”ê°€ì¿¼ë¦¬ ë°œìƒ
>
> 
>
> ##### 	ëŒ“ê¸€ì˜ ì‘ì„±ì id    => í˜ì¹˜ì¡°ì¸ìœ¼ë¡œëŠ” postì˜ memberë§Œ í•´ê²°, ì´ëŠ” comment.writerì´ë¯€ë¡œ í•´ê²° ë¶ˆê°€											(ë°°ì¹˜ì‚¬ì´ì¦ˆë¡œ ìµœì í™” ê°€ëŠ¥) => ì¶”ê°€ì¿¼ë¦¬ ë°œìƒ
>
> ##### 	ëŒ“ê¸€ì˜ ì‘ì„±ì ì´ë¦„
>
> ##### 	ëŒ“ê¸€ì˜ ì‘ì„±ì username
>
> ##### 	ëŒ“ê¸€ì— ë“±ë¡í•œ íŒŒì¼ë“¤ì˜ ê²½ë¡œ  => ì¶”ê°€ì¿¼ë¦¬ ë°œìƒ
>
> 
>
> ##### 	ëŒ“ê¸€ì— ë‹¬ë¦° ëŒ€ëŒ“ê¸€ì˜ ì •ë³´{
>
> ##### 					ëŒ€ëŒ“ê¸€ì˜ id
>
> ##### 					ëŒ€ëŒ“ê¸€ì˜ ë‚´ìš©
>
> ##### 					ëŒ€ëŒ“ê¸€ì˜ ì¢‹ì•„ìš” ìˆ˜ => likedBBSList.size()  => ì¶”ê°€ì¿¼ë¦¬ ë°œìƒ
>
> 
>
> ##### 					ëŒ€ëŒ“ê¸€ì˜ ì‘ì„±ì id   => ì¶”ê°€ì¿¼ë¦¬ ë°œìƒ
>
> ##### 					ëŒ€ëŒ“ê¸€ì˜ ì‘ì„±ì ì´ë¦„
>
> ##### 					ëŒ€ëŒ“ê¸€ì˜ ì‘ì„±ì username
>
> ##### 					ëŒ€ëŒ“ê¸€ì—ë“±ë¡í•œ íŒŒì¼ë“¤ì˜ ê²½ë¡œ   => ì¶”ê°€ì¿¼ë¦¬ ë°œìƒ
>
> ##### 				}
>
> ##### 		]

##### ë³´ë©´ ê·¸ëƒ¥ ì¿¼ë¦¬ê°€ ë„ˆë¬´ ë‹µë„ì—†ì´ ë°œìƒí•œë‹¤...!!!! (ì •í™•í•˜ì§„ ì•Šìœ¼ë‚˜, ìµœì†Œ 5ë²ˆ ì´ìƒì€ ì¿¼ë¦¬ê°€ ìƒê¸´ë‹¤!!!)

##### ê·¸ë˜ì„œ ì´ê²ƒì„ ì–´ë–»ê²Œ ìµœì í™” í•˜ë©´ ì¢‹ì„ì§€ ì •ë§ ì˜¤ë˜ ìƒê°í–ˆë‹¤.

<br/>

<br/>

## ìµœì í™” ë°©ë²•

##### ì†”ì§íˆ ì´ê²Œ ë§ê²Œ ìµœì í™” í•œê²ƒì¸ì§€ëŠ” ëª¨ë¥´ê² ë‹¤. ì‚¬ì‹¤ ì—”í‹°í‹°ë¥¼ í†µí•´ ì¡°íšŒí•˜ëŠ” ê²ƒì˜ ì‹œê°„ì„ ì•„ì§ ì¬ë³´ì§€ëŠ” ì•Šì•˜ê¸° ë•Œë¬¸ì— ì •í™•íˆ ì–¼ë§ˆë‚˜ ì°¨ì´ê°€ ë°œìƒí• ì§€ëŠ” ëª¨ë¥´ê² ë‹¤.

##### ìš°ì„  ì¿¼ë¦¬ ìˆ˜ë¥¼ ì¤„ì´ëŠ” ê²ƒì— ëª©í‘œë¥¼ ë‘ê³ , ë‚´ê°€ í•œ ë‘ê°€ì§€ ë°©ë²•ì„ ì†Œê°œí•˜ê² ë‹¤.

<br/>

### 1. <span style="color:orange">Where In í™œìš©, POST -> Comments -> ReComments ìˆœì„œë¡œ êµ¬í•˜ê¸°</span>

#### ì¿¼ë¦¬ ì´ 3íšŒ ë°œìƒ(ë°°ì¹˜ì‚¬ì´ì¦ˆì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŒ)

##### ì°¸ê³ ë¡œ ì•„ë˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì£¼ì„ì„ ë‹¬ì•„ë†“ì€ ê²ƒì´ë‹ˆ, ì§ì ‘ ì½”ë“œë¥¼ ì‘ì„±í•´ì„œ ì‹¤í—˜í•  ë•ŒëŠ” ì£¼ì„ì„ í•´ì œí•´ ì£¼ì–´ì•¼ í•œë‹¤.

```java
//@Repository
//@Slf4j
//@Transactional(readOnly = true)
```

<script src="https://gist.github.com/ShinDongHun1/82b9a4780e8d0a5cb952bf2dac2ab650.js"></script>

##### ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

#####  <span style="color:blue">1. Postì˜ Flat DTOë¥¼ ì¡°íšŒí•œë‹¤(UploadFileì˜ ìˆ˜ë§Œí¼ ì¤‘ë³µì´ ë°œìƒ)</span>

```java
 List<PostFlatDto> postFlatDtoList = findPostFlat(postId);
```

##### Querydslì„ ì‚¬ìš©í•˜ì˜€ê³   @QueryProjectionì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±ìë¥¼ í†µí•´ í”„ë¡œì ì…˜ í•˜ì˜€ë‹¤.

<script src="https://gist.github.com/ShinDongHun1/307310232384b2f49cdd8696437d899f.js"></script>

#####  <span style="color:blue">2. ê°€ì ¸ì˜¨ Flat DTOì—ì„œ ì¤‘ë³µì„ ì œê±°í•˜ì—¬ PostDTOë¡œ ë°”ê¾¼ë‹¤.</span>

```java
List<PostDto> postDtoList = changePostFlatToDto(postFlatDtoList);
```

##### ë°”ê¿”ì£¼ëŠ” ì½”ë“œ

```java
private List<PostDto> changePostFlatToDto(List<PostFlatDto> flat) {
        return flat.stream()
                .collect(
                        groupingBy(p -> new PostDto(p.getPostId(),p.getContent(),p.getViews(),p.getPostRole(), p.getLikedCount(), new MemberDto(p.getWriterId(), p.getWriterName(), p.getWriterUsername())),
                                mapping(p -> new UploadFileDto(p.getUploadFilePath()), toList())
                        )
                )
                .entrySet().stream()
                .map(e -> new PostDto(e.getKey().getPostId(), e.getKey().getContent(),e.getKey().getViews(), e.getKey().getPostRole(), e.getKey().getLikedCount(),
                        new MemberDto(e.getKey().getWriter().getMemberId(), e.getKey().getWriter().getName(), e.getKey().getWriter().getUsername()),

                        e.getValue())
                )
                .collect(toList());
    }
```

##### groupingByì™€ mappingì„ í†µí•´ Map\<PostDto, List\<UploadFileDto>>ë¥¼ ë§Œë“¤ì–´ì£¼ì—ˆë‹¤.

##### ë§Œë“¤ì–´ì§„ Map\<PostDto, List\<UploadFileDto>>ì˜ entrySetì„ ì´ìš©í•´ ê°ê°ì˜ entryë§ˆë‹¤ entryì— ë“¤ì–´ìˆëŠ” ì •ë³´ë¥¼ ê°€ì§€ê³  PostDtoë¥¼ ë§Œë“¤ì–´ì£¼ì—ˆê³ , ì´ë¥¼ Listë¡œ ë°˜í™˜í–ˆë‹¤.

<br/>

#####  <span style="color:blue">3. ë™ì¼í•˜ê²Œ postIdë¥¼ ê°€ì§€ê³  CommentDtoë„ ì¡°íšŒí•œë‹¤.</span>

#####  <span style="color:blue">4. ê°€ì ¸ì˜¨ CommentDtoì˜ Listë¥¼ postIdì™€ í•¨ê»˜ Mapìœ¼ë¡œ ë³€í™˜í•´ì¤€ë‹¤(Key:postId, Value: List\<CommentDto>)</span>

#####  <span style="color:blue">5. postDtoì˜ ìˆ˜ì •ìë¥¼ í†µí•´ ê°€ì ¸ì˜¨ CommentDtoListë¥¼ ì„¸íŒ…í•´ì¤€ë‹¤.</span>

```java
List<CommentDto> commentDtoList = fineComment(postId);//3ë²ˆ

Map<Long, List<CommentDto>> commentDtoMap = mappingCommentWithPostId(commentDtoList);//4ë²ˆ
postDto.setCommentList(commentDtoMap.get(postDto.getPostId()));//5ë²ˆ
```

<br/>

#### ì°¸ê³ 

##### ë°©ê¸ˆ ê¸€ ì“°ë©´ì„œ ì•Œì•„ë‚¸ê±´ë°, ì–´ì°¨í”¼ postDtoëŠ” í•˜ë‚˜ì´ë¯€ë¡œ, êµ³ì´ 4ë²ˆê³¼ 5ë²ˆì˜ ê³¼ì •ì„ ê±°ì¹˜ì§€ ì•Šê³  ë°”ë¡œ ì£¼ì…í•´ ì¤„ ìˆ˜ ìˆë‹¤.

```java
List<CommentDto> commentDtoList = fineComment(postId);//3ë²ˆ
postDto.setCommentList(commentDtoList);
```

##### ë‹¤ìŒê³¼ ê°™ì´ ë§ì´ë‹¤!

##### ë„ˆë¬´ ì–´ë ¤ì›Œì„œ ì„ ìƒë‹˜ì˜ ì½”ë“œ ë³´ê³  ë¬´ì‘ì • ì¹´í”¼í•´ì„œ ì ìš©í•˜ë‹¤ë³´ë‹ˆ, ì œëŒ€ë¡œ í™•ì¸í•˜ì§€ ëª»í–ˆì—ˆë‹¤. ã… ã… 

<br/>

##### <span style="color:orange">ê·¸ëŸ¬ë‚˜ CommentDtoëŠ” ì—¬ëŸ¬ê°œì´ë¯€ë¡œ, CommentDtoì— RecommentDtoë¥¼ ì„¸íŒ…í•´ ì¤„ ë•Œì—ëŠ” Mapìœ¼ë¡œ ë°”ê¾¼ í›„ forEachë¥¼ í†µí•´ ê°ê° ì£¼ì…í•´ ì£¼ì–´ì•¼ í•œë‹¤!</span>

```java
Map<Long, List<ReCommentDto>> reCommentDtoMap = mappingRe_CommentWithCommentId(reCommentDtos);

commentDtos.forEach(c -> c.setReCommentList(reCommentDtoMap.get(c.getCommentId())));
```

<br/>

#### ì°¸ê³  2. Inì ˆì˜ ì‚¬ìš©

```java
private List<Long> getCommentIds(List<CommentDto> commentDtos) {
        return commentDtos.stream().map(c -> c.getCommentId()).toList();
}

 private List<ReCommentFlatDto> findReCommentFlat(List<Long> commentIdList) {
        QUploadFile reCommentFile = new QUploadFile("re_c_upload_file");
        return query
                .select(
                        new QReCommentFlatDto(
                                reComment.comment.id,
                                reComment.id,
                                reComment.content,
                                reComment.likedBBSList.size(),
                                reComment.writer.id,
                                reComment.writer.name,
                                reComment.writer.username,
                                reCommentFile.filePath
                        )
                ).from(reComment)
                .where(reComment.comment.id.in(commentIdList))
                .leftJoin(reComment.uploadFileList, reCommentFile)
                .fetch();
    }
```

##### ì´ë ‡ê²Œ í•´ì„œ CommentIdì˜ Listë¥¼ ê°€ì ¸ì˜¨ ë’¤, ì´ë¥¼ ReCommentì˜ Flat DTOë¥¼ ê°€ì ¸ì˜¬ ë•Œ Where Inì ˆë¡œ ë„£ì–´ í•œêº¼ë²ˆì— ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ ë§Œë“¤ì—ˆë‹¤

<br/>

#### ì´ë ‡ê²Œ í•´ì„œ ì¿¼ë¦¬ 3ë²ˆ(Post 1ë²ˆ, Comment 1ë²ˆ, Recomment 1ë²ˆìœ¼ë¡œ ì¤„ì¼ ìˆ˜ ìˆì—ˆë‹¤.)

<br/>

<br/>

## 2. ê·¸ëƒ¥ ë‹¤ FlatDataë¡œ ê°€ì ¸ì™€ ë³€í™˜í•´ì£¼ê¸°

##### ì´ê±°ëŠ” ë§¨ ì²˜ìŒì—ëŠ” ìƒê°í•˜ì§€ ëª»í–ˆë‹¤. ê°€ì ¸ì˜¨ Flat dataë“¤ì„ ì¼ë°˜ Dtoë¡œ ì¤‘ë³µì„ ì œê±°í•˜ì—¬ ë³€í™˜í•˜ëŠ”ê²Œ ì •ë§ ì–´ë ¤ì› ê¸° ë•Œë¬¸ì´ë‹¤... ê·¸ë˜ì„œ ë¶ˆê°€ëŠ¥í•˜ë‹¤ ìƒê°í–ˆì—ˆëŠ”ë°, ìœ„ì˜ ë°©ë²•ìœ¼ë¡œ í•˜ë‹¤ë³´ë‹ˆ, í•  ìˆ˜ ìˆì„ ê±° ê°™ì•„ì„œ ë„ì „í•´ë³´ì•˜ë‹¤. ê²°ê³¼ëŠ” ì„±ê³µì´ë‹¤.

<script src="https://gist.github.com/ShinDongHun1/aea719811c91655d0eb530cd5a43defd.js"></script>

<br/>

##### í™•ì‹¤íˆ ìœ„ì— ì¿¼ë¦¬ê°€ 3ë²ˆ ë‚˜ê°€ëŠ” ì½”ë“œì— ë¹„í•´ ì´í•´í•˜ê¸°ë„ ì‰¬ì›Œì§„ ê²ƒ ê°™ê³  ë­”ê°€ ê·¸ë˜ë³´ì¸ë‹¤. 

##### ë°©ë²•ì€ ì´ëŸ¬í•˜ë‹¤

##### 1. ëª¨ë“  ë°ì´í„°ë¥¼ flat dtoë¡œ ì¡°íšŒí•œë‹¤.

##### 2. ê°€ì ¸ì˜¨ flat ë°ì´í„°ë¥¼ í†µí•´, post, comment, recomment ëª¨ë‘ ê°ê°ì˜ flat ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤(grouping, mapping, mapì„ ì‚¬ìš©í•˜ì—¬)

##### 3. ë˜‘ê°™ì´ commentDtoì— recommentDtoë¦¬ìŠ¤íŠ¸ë¥¼ ì„¸íŒ…í•´ ì£¼ê³ , PostDtoì— CommentDtoë¥¼ ì„¸íŒ…í•´ ì£¼ì—ˆë‹¤.

<br/>

<br/>

<br/>

## ìˆ˜ì •!!!!!

```java
comment.writer.id,
comment.writer.name,
comment.writer.username,

reComment.writer.id,
reComment.writer.name,
reComment.writer.username,
```

##### ì´ë¶€ë¶„ì„ ì£¼ëª©í•˜ì. ë‚˜ëŠ” ë§¨ ì²˜ìŒì— ì´ë ‡ê²Œ ì½”ë“œë¥¼ ì‘ì„±í–ì˜€ëŠ”ë°, í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ì‘ì„± ì¤‘, ì˜¤ë¥˜ê°€ ë‚¬ì—ˆë‹¤.

##### ìˆ˜í–‰ë˜ëŠ” ì¿¼ë¦¬ë¥¼ ë³´ë‹ˆ ë§‰ ì´ìƒí•œ cross joinê³¼ í•¨ê»˜ ê²°ê³¼ê°€ ì œëŒ€ë¡œ ë‚˜ì˜¤ì§€ ì•Šì•˜ë‹¤.

<br/>

#### ë¬´ì—‡ì´ ë¬¸ì œì˜€ë‚˜?

##### ì§„ì§œ í•˜ë‚˜í•˜ë‚˜ ë‹¤ ëœ¯ì–´ ê³ ì³ë´¤ë‹¤. ê²°ê³¼ëŠ” commentì˜ writerì™€, reCommentì˜ writerë¥¼ ê°€ì ¸ì˜¤ëŠ” ê³¼ì •ì—ì„œ FKë¥¼ ì„¤ì •í•´ì£¼ëŠ” ê³¼ì •ì—ì„œ ë­”ê°€ ë¬¸ì œê°€ ìƒê¸´ ê²ƒ ê°™ì•˜ë‹¤. 

<br/>

#### ì–´ë–»ê²Œ í•´ê²°í•˜ë‚˜?

```java
QUploadFile postFile = new QUploadFile("postFile");
        QUploadFile commentFile = new QUploadFile("c_upload_file");
        QUploadFile reCommentFile = new QUploadFile("re_c_upload_file");
        QMember cMember = new QMember("c_member");//ì¶”ê°€
        QMember reMember = new QMember("re_member");//ì¶”ê°€

        return query
        .select(new QAllPostFlat(
                                post.id,
                                post.title,
                                post.content,
                                post.likedBBSList.size(),
                                post.views,
                                post.postRole,
                                post.writer.id,
                                post.writer.name,
                                post.writer.username,
                                postFile.filePath,

                                comment.id,
                                comment.content,
                                comment.likedBBSList.size(),
                                cMember.id,//ì¶”ê°€
                                cMember.name,//ì¶”ê°€
                                cMember.username,//ì¶”ê°€
                                commentFile.filePath,

                                reComment.id,
                                reComment.content,
                                reComment.likedBBSList.size(),
                                reMember.id,//ì¶”ê°€
                                reMember.name,//ì¶”ê°€
                                reMember.username,//ì¶”ê°€
                                reCommentFile.filePath)
            )
            .from(post)
            .where(post.id.eq(postId))
            .leftJoin(post.uploadFileList, postFile)
            .leftJoin(post.commentList, comment)
            .leftJoin(comment.writer,  cMember)//ì¶”ê°€
            .leftJoin(comment.uploadFileList, commentFile)
            .leftJoin(comment.reCommentList, reComment)
            .leftJoin(reComment.writer, reMember)//ì¶”ê°€
            .leftJoin(reComment.uploadFileList, reCommentFile)
            .fetch();
```

##### ì£¼ì„ì„ í†µí•´, ë³€ê²½ëœ ë¶€ë¶„ì„ í™•ì¸í•˜ì. commentì˜ writerì™€ recommentì˜writerì— ëŒ€í•´ ì¡°ì¸ì„ ì‹œì¼œì£¼ë©´ ì•„ë˜ì™€ ê°™ì´ cross join ì—†ì´ ì˜ ì‹¤í–‰ë˜ëŠ”ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

![image-20211031054837535](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211031054837535.png)

<br/>

<br/>

## ìˆ˜ì • 2

<script src="https://gist.github.com/ShinDongHun1/32e8f7554cd92ed49de8255e2e9c67c4.js"></script>

##### ë‘ë²ˆì§¸ ì˜¤ë¥˜ëŠ” comment idë¡œ recommentDtoë¥¼ ë§¤í•‘í•˜ëŠ” ê³¼ì •ì—ì„œ ë°œìƒí–ˆë‹¤.

```java
 return reCommentDtoList.stream().collect(groupingBy(ReCommentDto::getCommentId));
```

##### <span style="color:red">java.lang.NullPointerException: element cannot be mapped to a null key</span>

##### ì™œ ì´ëŸ° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆëŠ”ì§€ ì›ì¸ì„ ì°¾ì•„ë³´ì•˜ë‹¤.

### ì›ì¸?

```java
private List<ReCommentDto> changeReCommentFlatToDto(List<AllPostFlat> flat) {
        return flat.stream()
                .collect(
        /**ì´ë¶€ë¶„ì„ ì£¼ëª©í•˜ì*/  groupingBy(rc -> new ReCommentDto(rc.getCommentId(), rc.getReCommentId(), rc.getReCommentContent(), rc.getReCommentLikedCount(), new MemberDto(rc.getReCommentWriterId(), rc.getReCommentWriterName(), rc.getReCommentWriterUsername())),
                                    mapping(rc -> new UploadFileDto(rc.getReCommentUploadFilePath()), toList())
                                    )
                )
                .entrySet().stream()
                .map(e -> new ReCommentDto(e.getKey().getCommentId(),
                                e.getKey().getReCommentId(),
                                e.getKey().getContent(),
                                e.getKey().getLikedCount(),
                                new MemberDto(e.getKey().getWriter().getMemberId(), e.getKey().getWriter().getName(), e.getKey().getWriter().getUsername()),

                                e.getValue()
                        )
                )
                .collect(toList());
    }
```

##### ì£¼ì„ì´ ë‹¬ë¦° ê³³ì„ ë³´ë©´, AllpostFlatì— ë“¤ì–´ìˆëŠ” ì •ë³´ë¥¼ ê°€ì§€ê³ , ê·¸ì¤‘ì—ì„œ ReCommentì— ê´€ë ¨ëœ ì •ë³´ë§Œ ë¹¼ì„œ ë§¤í•‘ì„ ì‹œì¼œì£¼ëŠ” ì—­í• ì„ í•œë‹¤.

##### ë§Œì•½ ëŒ“ê¸€ì€ ìˆëŠ”ë°, ëŒ€ëŒ“ê¸€ì´ ì—†ë‹¤ëŠ” ìƒí™©ì„ ê°€ì •í•´ë³´ì. AllPostFlatì—ëŠ” ëŒ“ê¸€ì˜ ì •ë³´ê¹Œì§€ë§Œ ë“¤ì–´ê°ˆê²ƒì´ê³ , ReCommentIdë¶€í„°ëŠ” ë‹¤ nullê°’ì´ ë“¤ì–´ê°ˆ ê²ƒì´ë‹¤.

##### ë‹¤ìŒê³¼ ê°™ì€ ìƒí™©ì—ì„œ groupingByë¥¼ í†µí•´ ê·¸ë£¹í™” ì‹œì¼œì¤€ë‹¤ë©´, re.getCommentId()ë§Œ ì¡´ì¬í•˜ê³ , ë‚˜ë¨¸ì§€ ê°’ì€ ë‹¤  nullì¸ ReCommentDtoê°€ ìƒì„±ëœë‹¤.

##### ì¦‰ ReCommentëŠ” ì—†ì§€ë§Œ, ReComment DTOê°€ ìƒê²¨ë‚œê²ƒì´ë‹¤. ë”°ë¼ì„œ ReCommentDto::getCommentId (ë°”ê¾¸ìë©´ reComment -> reComment.getCommentId)ë¥¼ í•˜ëŠ” ê³¼ì •ì—ì„œ, reCommentIdëŠ” nullì´ë¯€ë¡œ ìœ„ì™€ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë˜ ê²ƒì´ë‹¤.

<br/>

### í•´ê²°?

```java
 if(commentDtoList.get(0).getCommentId()==null){//ì¶”ê°€
	return postDto;
}
        
        
if(reCommentDtoList.get(0).getReCommentId()==null){//ì¶”ê°€
	return postDto;
}
```

##### ìœ„ì™€ ê°™ì´ ì¡°ê±´ì„ ì¶”ê°€í•´ì£¼ì–´ í•´ê²°í–ˆë‹¤.

<br/>

<br/>

<br/>

<br/>

## ì„±ëŠ¥ì°¨ì´?

##### ì•„ì§ ë°ì´í„°ê°€ ë§ì§€ ì•Šì•„ì„œ ì˜ ëª¨ë¥´ê² ë‹¤. ë”ë¯¸ë°ì´í„° 10000ê°œì •ë„ ë„£ì–´ë³¸ ê²°ê³¼ 1ì˜ ë°©ë²•ê³¼ 2ì˜ ë°©ë²•ì€ ë‘˜ ë‹¤ 1ë¶„ì •ë„ ì†Œìš”ë˜ì—ˆê³ , 2ì˜ ë°©ë²•ì´ 1~2ì´ˆì •ë„ ë” ë¹¨ëë‹¤. ê·¸ëŸ¬ë‚˜ ì°¨ì´ë¥¼ ë¹„êµí• ë•Œë§ˆë‹¤ ê³„ì† ì†ë„ê°€ ì°¨ì´ê°€ ì¢€ ìˆì–´ì„œ ì•„ì§ ì˜ ëª¨ë¥´ê² ë‹¤...ã…  ê·¸ë˜ë„ ì¼ë‹¨ 2ì˜ ë°©ë²•ì´ ê³„ì†í•´ì„œ ë” ë¹¨ë¦¬ ë‚˜ì˜¤ê¸´ í–ˆë‹¤!

![image-20211030050811234](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211030050811234.png)

![image-20211030050708888](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211030050708888.png)

##### ê·¼ë° ê³„ì† ë§‰ ë°”ë€ë‹¤ ã…  ì•„ë§ˆ ë³„ ì°¨ì´ ì—†ì„ì§€ë„..

<br/>

<br/>

### ğŸ“” Reference

[ì¸í”„ëŸ° - ì‹¤ì „ ìŠ¤í”„ë§ ë¶€íŠ¸ì™€  JPAí™œìš© 2í¸, ì£¼ë¬¸ì¡°íšŒ V5- ì»¬ë ‰ì…˜ ì¡°íšŒ ìµœì í™”](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-JPA-API%EA%B0%9C%EB%B0%9C-%EC%84%B1%EB%8A%A5%EC%B5%9C%EC%A0%81%ED%99%94/lecture/24335?tab=curriculum)

[ì¸í”„ëŸ° - ì‹¤ì „ ìŠ¤í”„ë§ ë¶€íŠ¸ì™€  JPAí™œìš© 2í¸, ì£¼ë¬¸ì¡°íšŒ V6 - í”Œë« ë°ì´í„° ìµœì í™”](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-JPA-API%EA%B0%9C%EB%B0%9C-%EC%84%B1%EB%8A%A5%EC%B5%9C%EC%A0%81%ED%99%94/lecture/24336?tab=curriculum)