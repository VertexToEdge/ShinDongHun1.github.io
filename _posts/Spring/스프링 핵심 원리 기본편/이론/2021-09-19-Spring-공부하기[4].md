---
title:  "Spring 공부하기[4]"
excerpt: "싱글톤과 싱글톤 컨테이너"
date:   2021-09-19 00:18:00 +0900
header:
  teaser: /assets/images/spring.png

categories: javaSpring
tags:
  - Java
  - Spring
last_modified_at: 2021-10-09T00:18:00-05:00
---

<br/>

[스프링 핵심 원리 기본편](https://www.inflearn.com/course/스프링-핵심-원리-기본편)를 보고 대부분 공부하고 정리한 내용을 올립니다

#### (10월 9일 수정)

<br/>

## **💡** 싱글톤이란

스프링은 태생이 기업용 온라인 서비스 기술을 지원하기 위해서 탄생했다.<br/>대부분의 스프링 애플리케이션은 웹 애플리케이션이며 **보통 여러 고객이 동시에 요청**을 한다.

고객이 오브젝트를 요청한다면, 스프링 컨테이너는 오브젝트를 하나 만들어서 고객에게 반환한다.<br/>두명의 고객이 오브젝트를 를 요청한다면?  2개를 만들어서 반환할 것이고<br/>100만명의 고객이 요청한다면, 100만개를 만들어서 반환할 것이다.

따라서 고객이 많아지면 많아질수록 메모리 낭비가 심해질 것이다.<br/>어떻게 해결하면 좋을까? 

=> 해당 객체를 **단 1개만 생성**하고, **공유**하도록 설계하면 된다. 

#### => 싱글톤 패턴

<br/>

<br/>

## **💡** 싱글톤 패턴

##### 싱글톤 패턴은 <span style="color:orange">클래스의 인스턴스(객체)가 딱 1개만 생성되는 것을 보장</span>하는 **[디자인 패턴](https://gmlwjd9405.github.io/2018/07/06/design-pattern.html)**이다.

싱글톤을 구현하는 방법 =>  [**싱글톤 패턴을 구현하는 6가지 방법**](https://readystory.tistory.com/116)

여기서는 객체를 미리 생성하두는 가장 단순한 방법을 사용했다.

<script src="https://gist.github.com/ShinDongHun1/4d48fb48ac4bf46a830d08a644095954.js"></script>

위의 코드를 보면 instance는 단 1개만 생성될 수 있으며, 생성자를 private으로 막아서 SingletionService 객체를 생성할 수도 없다.

<br/>

<br/>

## **💡** 싱글톤 패턴의 문제점

- 싱글톤 패턴을 구현하는 코드 자체가 많이 필요하다 => **굉장히 귀찮다**

- 의존관계상 클라이언트가 구체 코드에 의존하므로 **<span style="color:orange">DIP(의존관계 역전 원칙)</span>**를 위반한다 

  ( ex : 구체클래스.getInstance()) 

- 클라이언트가 구체 코드에 의존하므로 **<span style="color:orange">OCP(개방-폐쇄 원칙)</span>**를 위반할 가능성이 높다.

- 테스트하기 어렵다

- 내부 속성을 변경하거나 초기화하기 어렵다

- private 생성자로 자식 클래스를 만들기 어렵다.

- 결론적으로 유연성이 떨어진다

=> 위와 같은 이유들 때문에 **안티패턴**이라 불리기도 한다.

<br/>

<br/>

## **💡** 싱글톤 컨테이너

**<span style="color:orange">스프링 컨테이너</span>**는 위와 같은 **<span style="color:orange">싱글톤 패턴의 문제점을 해결</span>**하면서, 객체 인스턴스를 **<span style="color:orange">싱글톤으로 관리</span>**한다.

지금까지 우리가 공부했던 스프링 빈이, 싱글톤으로 관리되는 빈이다.

<br/>

- **스프링 컨테이너**는 **싱글톤 패턴을 적용하지 않아도, 객체 인스턴스를 싱글톤으로 관리**한다. 
  - 이전 포스트에서 공부했던 싱글톤 컨테이너 생성 과정을 보면, 컨테이너는 스프링 빈 객체를 하나만 생성해서 관리한다.
- **스프링 컨테이너**는 <span style="color:orange">**싱글톤 컨테이너**</span> 역할을 한다. 이렇게 **<span style="color:orange">싱글톤 객체를 생성하고 관리</span>**하는 기능을 <span style="color:orange">**싱글톤 레지스트리**</span>라 한다.
- 스프링 컨테이너의 이런 기능 덕분에 싱글톤 패턴의 모든 단점을 해결하면서 객체를 싱글톤으로 유지할 수 있다.
- 싱글톤 패턴을 위한 지저분한 코드가 들어가지 않아도 된다.
- DIP, OCP, 테스트, private 생성자로부터 자유롭게 싱글톤을 사용할 수 있다.

<br/>

#### 스프링 컨테이너 테스트

<script src="https://gist.github.com/ShinDongHun1/1633bcc96c0c507eff746deb28e19f98.js"></script>

<br/>

참고로 스프링의 기본 동작 방식은 싱글톤이나, 싱글톤 방식만 지원하는 것은 아니다! <br/>요청할 때 마다 새로운 객체를 생성해서 반환하게 할 수도 있다.(빈 스코프에서 설명)

<br/>

<br/>

## **💡** 싱글톤 방식의 주의점

싱글톤 방식을 사용할 때 꼭 주의해야 할 점이 있다. 

싱글톤 방식에서는 여러 클라이언트가 **하나의 같은 객체 인스턴스를 공유**하기 때문에

싱글톤 객체는 <span style="color:red">**상태를 유지(stateful)하게 설계하면 안된다.**</span>

#### <span style="color:orange">**무상태(stateless)로 설계**</span>해야 한다!

- **<span style="color:orange">특정 클라이언트에 의존적인 필드가 있으면 안된다.</span>**
- 즉 특정 클라이언트가 **<span style="color:orange">값을 변경할 수 있는 필드가 있으면 안된다.</span>**
- 가급적 **읽기만 가능**해야 한다.
- **필드 대신**에 자바에서 공유되지 않는, **지역변수, 파라미터, ThreadLocal등을 사용**해야 한다.

스프링빈의 필드에 공유 값을 설정하면 <span style="color:red">**정말 큰 장애가 발생**</span>할 수 있다!!!

<br/>

**StatefulService.java**

<script src="https://gist.github.com/ShinDongHun1/e0d2fa2fb9066642104908fbf78ce69e.js"></script>

<br/>

**StatefulServiceTest.java**

<script src="https://gist.github.com/ShinDongHun1/21b1198a5db76b10df7e8c337691603c.js"></script>

<br/>

**StatefulService**를 보면, **특정 클라이언트가 price값을 변경**한다! => 특정 클라이언트가 **값을 변경할 수 있는 필드가 있으면 안된다.**

<br/>

<br/>

## **💡** @Configuration과 싱글톤

**AppConfig 코드를 보자**

<script src="https://gist.github.com/ShinDongHun1/094daf07381198b26aa0eb0915fb5715.js"></script>

**memberService** 빈을 만드는 코드를 보면, memberRepository를 생성한다.<br/>memberRepository는 **new MemoryMemberRepository();를 실행**한다.

<br/>

**orderService** 빈을 만드는 코드를 보면, memberRepository를 생성한다.<br/>memberRepository는 **new MemoryMemberRepository();**를 실행한다.

<br/>

결과적으로는 각각 다른 2개의 MemoryMemberRepository가 생성되면서 싱글톤이 깨지는 것 처럼 보인다.

그러나 확인해보면 그렇지 않다는것을 알 수 있다.

<br/>

<br/>

## **💡** @Configuration과 바이트코드 조작

**스프링 컨테이너**는 **싱글톤 레지스트리**다. 

따라서 스프링 빈이 싱글톤이 되도록 보장해주어야 한다.

스프링은 클래스의 **바이트코드를 조작하는 라이브러리를 사용**한다. 

비밀은 <span style="color:orange">**@Configuration**</span> 을 적용한 **AppConfig** 에 있다.

<br/>

다음과 같은 코드를 보자

<script src="https://gist.github.com/ShinDongHun1/4bf8f77f78856e343a25a436511cd39b.js"></script>

결과에

> **bean = class hello.core.AppConfig$$EnhancerBySpringCGLIB$$bd479d70**

class hello.core.AppConfig 가 출력되어야 정상일텐데, 뭔가 이상한게 붙어있다.

이것은 내가 만든 클래스가 아니다.

스프링이 **<span style="color:orange">CGLIB라는 바이트코드 조작 라이브러리를 사용</span>**해서 AppConfig 클래스를 **상속받은 임의의 다른 클래스**를 만들고, 그 다른 클래스를 **스프링 빈으로 등록**한 것이다!

![image-20211009232607416](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211009232607416.png)

<br/>

AppConfig@CGLIB 에서는 아마 다음과 같은 방식으로 코드가 작동할것이다

> 만약 memoryMemberRepository가 이미 **스프링 컨테이너에 등록되어 있으면**
>
> return **스프링 컨테이너에서 찾아서 반환**;
>
> **스프링 컨테이너에 없으면**?
>
> 기존 로직을 호출해서 **MemoryMemberRepository를 생성하고 스프링 컨테이너**에 등록
>
> return 반환;

<br/>

#### **✏️** <span style="color:orange">@Configuration</span>을 적용하지 않고, <span style="color:green">@Bean</span>만 적용한다면?

##### @Bean만 사용해도 스프링 빈으로 등록되지만, 싱글톤을 보장하지 않는다.

<br/>

<br/>

## **🧾** 정리

#### ✏ 싱글톤 패턴은 <span style="color:orange">클래스의 인스턴스(객체)가 딱 1개만 생성되는 것을 보장</span>하는 디자인 패턴이다.

#### ✏ **<span style="color:green">스프링 컨테이너(ApplicationContext)</span>**는 **DI컨테이너**이자, <span style="color:green">**싱글톤 컨테이너**</span>의 역할을 수행한다

#### ✏ @Bean만 사용해도 스프링 빈으로 등록되지만, 싱글톤을 보장하지 않는다

#### ✏ 그냥 고민 말고 @Configuration을 붙이자

