---
title:  "리조트 프로젝트 [N+1 문제 해결하기]"
excerpt: "N+1 문제 해결하기"
date:   2021-10-03 21:10:00 +0900
header:
  teaser: /assets/images/spring.png

categories: LIZOT
tags:
  - Java
  - Spring
  - MVC
  - JPA
  - project
last_modified_at: 2021-10-03T21:10:00-05:00




---

<br/>

<br/>

오늘은 재헌이와 함께 하기로 한 리조또 프로젝트의 코드를 작성하던 도중 만난 N+1문제를 풀었던 과정을 서술하겠다

<br/><br/>

프로그램에 로그인을 하면, 해당 학생이 듣는 강의의 리스트를 같이 반환해 주었는데 이때 쿼리가 3번씩 나갔었다.

<br/>

 select
        takelectur0_.member_id as member_i5_5_1_,
        takelectur0_.linked_lecture_id as linked_l1_5_1_,
        takelectur0_.linked_lecture_id as linked_l1_5_0_,
        takelectur0_.created_date as created_2_5_0_,
        takelectur0_.last_modified_date as last_mod3_5_0_,
        takelectur0_.lecture_id as lecture_4_5_0_,
        takelectur0_.member_id as member_i5_5_0_ 
    from
        take_lecture takelectur0_ 
    where
        takelectur0_.member_id=?
2021-10-03 20:46:27.634 DEBUG 22932 --- [nio-8080-exec-2] org.hibernate.SQL                        : 
    select
        lecture0_.lecture_id as lecture_1_1_0_,
        lecture0_.created_date as created_2_1_0_,
        lecture0_.last_modified_date as last_mod3_1_0_,
        lecture0_.name as name4_1_0_,
        lecture0_.member_id as member_i5_1_0_ 
    from
        lecture lecture0_ 
    where
        lecture0_.lecture_id in (
            ?, ?, ?
        )
2021-10-03 20:46:27.635 DEBUG 22932 --- [nio-8080-exec-2] org.hibernate.SQL                        : 
    select
        professor0_.member_id as member_i2_2_0_,
        professor0_.created_date as created_3_2_0_,
        professor0_.last_modified_date as last_mod4_2_0_,
        professor0_.name as name5_2_0_,
        professor0_.password as password6_2_0_,
        professor0_.username as username7_2_0_ 
    from
        member professor0_ 
    where
        professor0_.member_id in (
            ?, ?, ?
        ) 
        and professor0_.dtype='P'



![image-20211003204724398](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211003204724398.png)

이런식으로.

코드는 다음과 같았다.

#### MemberController.java

<script src="https://gist.github.com/ShinDongHun1/7dffd47469934335c6aa6de2ec6cecb0.js"></script>
<br/>

#### ResponseStudentDto.java

<script src="https://gist.github.com/ShinDongHun1/36be60f54cf34432d6ccc3fa9f7db65e.js"></script>
<br/>

#### LectureDto.java

<script src="https://gist.github.com/ShinDongHun1/30161ae56f2b833bef954bd4d4bfd8d0.js"></script>

왜 세번이 나갔을까??????

##### ResponseStudentDto에서 student.getTakeLectures() 를 한 후 

##### .map(takeLecture ->new LectureDto(takeLecture))를 통해 들어가

##### takeLecture.getLecture()를 하면서 takeLecture를 사용하기 때문에 이 과정에서 쿼리가 한번

##### (원래는 takeLecture 의 수만큼 나가야 하겠지만 spring.jpa.properties.hibernate.default_batch_fetch_size = 100으로 해주었기 때문에 100개 미만이면 쿼리가 한번만 수행된다.)

##### LectureDto 에서 takelecture.getLeture().getName(); 으로 쿼리가 한번,

##### takelecture.getLecture().getProfessor().getName(); 으로 쿼리가 한번

##### 이렇게 Member의 TakeLecture을 불러오기 위해서는 쿼리가 3번이 추가로 더 필요했었다.

어떻게 해야 줄일 수 있을까 한참을 고민하다 내가 해결했던 방법은 이것이다.

먼저 TakeLectureRepository를 만들어 주었다. 

<br/>

### TakeLectureRepository.java

<script src="https://gist.github.com/ShinDongHun1/25e4432d34f53b8da5a4a3e6481bec71.js"></script>

##### 다음과 같이 Student와 Professor을 fetch join을 통해 가져왔다

##### (참고로 tl.lecture.professor p 를 하면 오류가 났는데 이유를 모르겠다..ㅠㅜ)

##### <br/>

### MemberController.java

<script src="https://gist.github.com/ShinDongHun1/54dcab0da6341fb21c07cec8cfb58227.js"></script>
##### 다음과 같이 takeLectures 를 받아와서 ResponseStudentDto의 생성자에 넘겨주었다.

<br/>

### ResponseStudentDto.java

<script src="https://gist.github.com/ShinDongHun1/b73f205f1fc9a823a04574c938f3bc4e.js"></script>

<br/>

### LectureDto.java

<script src="https://gist.github.com/ShinDongHun1/2698350c4fd3e41966447c0678d5bc87.js"></script>

<br/>

이렇게 fetch join을 사용하여, Lecture와 Professor을 모두 조회하여 N+1 문제를 해결하였다.

참고로 takeLecture 컬렉션을 가져올때도 fetch join을 쓸 수는 있었지만, 수업때 컬렉션에 페치조인 쓰는것이 별로 좋은 방법이 아니라 했었던 것 같아, 선생님이 알려주신 batch_fetch_size = 100 으로 해결하였다.

결과는 다음과 같이 수행된다.

![image-20211003211148407](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211003211148407.png)

필요 없는 필드들이 많아, 다음에는 DTO로 직접 조회하는 방법도 써볼까 생각을 하고는 있다만,,, 음 굳이 그럴 필요는 또 없을 거 같기도 하구..ㅎ

아무튼 그래서 오늘 N+1문제를 해결해서 기분이 참 좋았다 ㅎㅎ