---
title:  "리조또 프로젝트 [1]"
excerpt: "도메인 모델과 테이블 설계"
date:   2021-10-03 21:10:00 +0900
header:
  teaser: /assets/images/spring.png

categories: project
tags:
  - Java
  - Spring
  - MVC
  - JPA
  - project
last_modified_at: 2021-10-03T21:10:00-05:00





---

<br/>

<br/>

#### 재헌이랑 같이 스프링 공부도 할 겸, 경험을 쌓고 싶어서 같이 리조뜨를 만들기로 했다 ㅎ. 왜 리조뜨인지는 비밀 ㅎ

오늘은 우선 도메인 모델과 테이블을 설계하고, 할 짓 없는 나는 혼자서 조금 많이 만들어보았다.

<br/>

### 도메인 모델 설계

![리조또 객체분석](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/%EB%A6%AC%EC%A1%B0%EB%98%90%20%EA%B0%9D%EC%B2%B4%EB%B6%84%EC%84%9D.png)

돈이 없어서 무료로 쓸 수 있는 것 중에는 이게 최선인 것 같았다.

사실 저기서 Lecture에서 Member로 갈 수 있게 했어야 했는데 조금 설계 미스였다.

조금 나중에 깨닫고 절망해버림..ㅎㅎ 파일이 날라가서 다시 고칠수가 없어서 그냥 글로 남기는걸루.ㅎ.

<br/>

### 테이블 설계

![리조또 테이블분석](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/%EB%A6%AC%EC%A1%B0%EB%98%90%20%ED%85%8C%EC%9D%B4%EB%B8%94%EB%B6%84%EC%84%9D.png)

우선은 이렇게 만들었다.

코드들은 음 너무 많아서 하나하나 올리기는 그렇구 ㅠ

조금 생각할것들이 있는 코드들만 올려야징

<br/>

### Student.java

<script src="https://gist.github.com/ShinDongHun1/84cd1addde018ffeb45cfb6f8914daa2.js"></script>

##### 우선 takeLectures와의 관계는 보다싶이 1대 다 관계이고, 왜 Lecture가 아니라 TakeLecture를 썼냐면, 다대 다 매핑은 굉장히 좋지 않다고 선생님이 말씀해 주셨기에, Lecture와 Student의 다대 다 매핑을 TakeLecture 테이블을 만들어서 1대 다, 다대 1 관계로 풀어주었다.

##### 그리고 연관관계의 주인은 TakeLecture이나, 학생 쪽에서  TakeLecture를 등록하는 일이 많을 것 같아서 양방향으로 설정한 후, 연관관계 편의 메소드를 설정해주었다.

##### 그리고 TakeLecture 와 생명주기를 맞추기 위해 cascade = CascadeType.ALL, orphanRemoval = true 를 설정해주었다.

<br/>

### Professor.java

<script src="https://gist.github.com/ShinDongHun1/e8e553ec13b350fd6877fe81c20e972c.js"></script>

웃긴게 Professor는 연관관계 편의 메소드를 정해주지 않고, Lecture에서 해주었다..

먼가 연관관계 편의 메소드 설정해주기가 너무 머리아프다 ㅠㅠ 어디에 해야할지 잘 모르겠다 ㅠㅠ

근데 지금 생각해 보니 chargeLecture 에도 cascade = CascadeType.ALL, orphanRemoval = true 를 해주는 것이 좋다는 생각이 들었다..??

<br/>

### Lecture.java

<script src="https://gist.github.com/ShinDongHun1/f578978fca473464e432b762f4bbb709.js"></script>

lecture 클래스다. 

연관관계 편의 메소드를 여기서 설정해주었다.

<br/>

### LectureRepository.java

<script src="https://gist.github.com/ShinDongHun1/6c35beb54375c421142a4c333778b9fd.js"></script>

아 여기서도 엄청 애먹었다...

이게 @EntityGraph를 쓰면 어쩔때는 cross join이, 어쩔때는 left outer join이 실행되길래 무슨 차이인가 했는데...

일단 내 실험으로 얻는 결론은 이렇다.

##### @Query("select l from Lecture l where l.professor.username = :professorId") 이런 식으로 l.professor을 통해 조회해 온 곳에 Entitygraph를 쓰면 크로스 조인이 발생하는듯

<br/>

### MemberController.java

<script src="https://gist.github.com/ShinDongHun1/5fe1354928fe5d53a0dc714f7193d91c.js"></script>

로그인만 보자. 여기서 N+1 문제가 발생하였고, 일단 잘 해결한 것 같다.

### TakeLectureRepositoryImpl.java

<script src="https://gist.github.com/ShinDongHun1/97f2d8707a039dff5653cbd2b67259a5.js"></script>

우선 findWithStudentAndProfessor 메소드를 보면, 페치 조인을 통해, TakeLecture 를 조회하면서 학생, lecture, professor을 함께 조회해 온다. 이때 tl.lecture.professor p 라고 작성하게 되면 오류가 발생했다. 자세하게는 따로 글을 써놨으니 여기서는 대충만 말해야징.

##### 아무튼 이어서 new ResponseEntity<>(e.getMessage(), HttpStatus.UNAUTHORIZED); 코드를 보자

<br/>

### ResponseStudentDto.java

<script src="https://gist.github.com/ShinDongHun1/9ffd197fcf115216bfca9b60eebc8d0a.js"></script>

일단 생성자가 회원가입용이랑 로그인용으로 나뉜것부터 조금 이상한 것 같다. 이럴바엔 그냥 새로 하나 만들어야 했었나 싶기두 하고,..ㅠㅠ 잘 모르겠다.

(참고로 지금 생각났는데 저기 DTYPE은 필요 없는 것 같다. 결국 한번도 안 씀)

 chargeLecture = takeLectures.stream() 
                                  .map(takeLecture -> new LectureDto(takeLecture)) 
                                   .collect(Collectors.toList()); 

이 코드는, takeLectures 배열에 들어있는 takeLecture들을 각각 LectureDto로 바꾸어 리스트로 만들어주는 코드이다. 

<br/>

### LectureDto.java

<script src="https://gist.github.com/ShinDongHun1/26de4c4116700f762e3ebebd6e212323.js"></script>

학생용을 보면 name 을 가져올 때

takeLecture.getLecture().getName(); 통해

TakeLecture를 가져오는 쿼리 한번

 Lecture가져오는 쿼리 한번,

 Professor가져오는 쿼리 한 번

이렇게 총 3번의 쿼리가 발생하게 된다.

그러나 이 문제를 위의 fetch join으로 풀었으며,

 chargeLecture = takeLectures.stream() 
                                  .map(takeLecture -> new LectureDto(takeLecture)) 
                                   .collect(Collectors.toList()); 

를 함으로써 takeLecture 마다 쿼리가 발생하는 문제를

```api
spring.jpa.properties.hibernate.default_batch_fetch_size = 100
```

를 통해 해결하였다 :D

이것 말고도 구현 엄청 많이 했는데, 일단 기억에 남았던 건 이것들인 거 같다 :D