---
title:  "êµ¬ê¸€ ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸° - ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ AWSë¡œ í˜¼ì êµ¬í˜„í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤"
excerpt: "ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ AWSë¡œ í˜¼ì êµ¬í˜„í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤ 4"
date:   2021-11-23 01:16:00 
header:
  teaser: /assets/images/spring.png

categories: purpleBook
tags:
  - Java
  - Spring
last_modified_at: 2021-11-23T01:16:00


---

<br/>

<br/>

## ìŠ¤í”„ë§ ì‹œíë¦¬í‹°

ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ëŠ” ë§‰ê°•í•œ ì¸ì¦ê³¼ ì¸ê°€(ê¶Œí•œ ë¶€ì—¬) ê¸°ëŠ¥ì„ ê°€ì§„ í”„ë ˆì„ì›Œí¬ì´ë‹¤.

ì‚¬ì‹¤ìƒ ìŠ¤í”„ë§ ê¸°ë°˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ë³´ì•ˆì„ ìœ„í•œ í‘œì¤€ì´ë¼ê³  ë³´ë©´ ëœë‹¤.

ì¸í„°ì…‰í„°, í•„í„° ê¸°ë°˜ì˜ ë³´ì•ˆ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ëŠ” ê²ƒë³´ë‹¤ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ë¥¼ í†µí•´ êµ¬í˜„í•˜ëŠ” ê²ƒì„ ì ê·¹ ê¶Œì¥í•˜ê³  ìˆë‹¤.

ì—¬ê¸°ì„œëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì™€ OAuth2ì„ êµ¬í˜„í•œ êµ¬ê¸€ ë¡œê·¸ì¸ì„ ì—°ë™í•˜ì—¬ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ë§Œë“¤ì–´ë³´ê² ë‹¤.

<br/>

## ìŠ¤í”„ë§ ë¶€íŠ¸ 1.5 VS ìŠ¤í”„ë§ ë¶€íŠ¸ 2.0

ìŠ¤í”„ë§ ë¶€íŠ¸ 1.5ì—ì„œì˜ OAuth2 ì—°ë™ ë°©ë²•ì´ 2.0ì—ì„œëŠ” í¬ê²Œ ë³€ê²½ë˜ì—ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì¸í„°ë„· ìë£Œë“¤ì„ ë³´ë©´ ì„¤ì • ë°©ë²•ì´ í¬ê²Œ ë‹¬ë¼ì§„ ê²ƒì´ ì—†ëŠ”ë° ì´ëŠ” 

##### spring-security-oauth2-autoconfigure 

ë•ë¶„ì´ë‹¤.

ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ê²½ìš° ìŠ¤í”„ë§ ë¶€íŠ¸ 2ì—ì„œë„ 1.5ì—ì„œì˜ ì„¤ì •ì„ ê·¸ëŒ€ë¡œ ê°€ì ¸ê°ˆ ìˆ˜ ìˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì´ ì±…ì˜ í•„ìëŠ” Spring Security Oauth2 Client ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì„œ ì§„í–‰í•œë‹¤ ë°í˜”ë‹¤. ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

- ìŠ¤í”„ë§ íŒ€ì—ì„œ ê¸°ì¡´ 1.5ì—ì„œ ì‚¬ìš©ë˜ë˜ spring-security-oauth í”„ë¡œì íŠ¸ëŠ” ìœ ì§€ ìƒíƒœë¡œ ê²°ì •í–ˆìœ¼ë©° ë”ëŠ” ì‹ ê·œ ê¸°ëŠ¥ì€ ì¶”ê°€í•˜ì§€ ì•Šê³  ë²„ê·¸ ìˆ˜ì • ì •ë„ì˜ ê¸°ëŠ¥ë§Œ ì¶”ê°€ë  ì˜ˆì •, ì‹ ê·œ ê¸°ëŠ¥ì€ ìƒˆ oauth2 ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œë§Œ ì§€ì›í•˜ê² ë‹¤ê³  ì„ ì–¸.
- ìŠ¤í”„ë§ ë¶€íŠ¸ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬(starter)ì¶œì‹œ
- ...

ê·¸ë¦¬ê³  í•œ ê°€ì§€ ë” ì´ì•¼ê¸°í•˜ì§€ë©´, ì´ ì±…(ì´ ê¸€)ì´ì™¸ì— ìŠ¤í”„ë§ ë¶€íŠ¸ 2 ë°©ì‹ì˜ ìë£Œë¥¼ ì°¾ê³  ì‹¶ì€ ê²½ìš° ì¸í„°ë„· ìë£Œë“¤ ì‚¬ì´ì—ì„œ ë‹¤ìŒ ë‘ ê°€ì§€ë§Œ í™•ì¸í•˜ë©´ ëœë‹¤.

ë¨¼ì € spring-security-oauth2-autoconfigure ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¼ëŠ”ì§€

application.properties í˜¹ì€ application.yml ì •ë³´ê°€ ë‹¤ìŒê³¼ ê°™ì´ ì°¨ì´ê°€ ìˆëŠ”ì§€.

##### ìŠ¤í”„ë§ ë¶€íŠ¸ 1.5

![image-20211122155751761](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122155751761.png)

<br/>

##### ìŠ¤í”„ë§ ë¶€íŠ¸ 2.0

![image-20211122155843903](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122155843903.png)

<br/>

ìŠ¤í”„ë§ ë¶€íŠ¸ 1.5 ë°©ì‹ì—ì„œëŠ” url ì£¼ì†Œë¥¼ ëª¨ë‘ ëª…ì‹œí•´ì•¼ í–ˆì§€ë§Œ 2.0 ë°©ì‹ì—ì„œëŠ” client ì¸ì¦ ì •ë³´ë§Œ ì…ë ¥í•˜ë©´ ëœë‹¤. 1.5 ë°©ì‹ì—ì„œ ì§ì ‘ ì…ë ¥í–ˆë˜ ê°’ë“¤ì€ 2.0 ë²„ì „ìœ¼ë¡œ ì˜¤ë©´ì„œ ëª¨ë‘ enumìœ¼ë¡œ ëŒ€ì²´ë˜ì—ˆë‹¤.

**CommonOAuth2Provider**ë¼ëŠ” enumì´ ìƒˆë¡­ê²Œ ì¶”ê°€ë˜ì–´ **êµ¬ê¸€, ê¹ƒí—ˆë¸Œ, í˜ì´ìŠ¤ë¶, ì˜¥íƒ€**ì˜ ê¸°ë³¸ ì„¤ì •ê°’ì€ ëª¨ë‘ ì—¬ê¸°ì„œ ì œê³µí•œë‹¤.

```java
public enum CommonOAuth2Provider {

   GOOGLE {

      @Override
      public Builder getBuilder(String registrationId) {
         ClientRegistration.Builder builder = getBuilder(registrationId,
               ClientAuthenticationMethod.CLIENT_SECRET_BASIC, DEFAULT_REDIRECT_URL);
         builder.scope("openid", "profile", "email");
         builder.authorizationUri("https://accounts.google.com/o/oauth2/v2/auth");
         builder.tokenUri("https://www.googleapis.com/oauth2/v4/token");
         builder.jwkSetUri("https://www.googleapis.com/oauth2/v3/certs");
         builder.issuerUri("https://accounts.google.com");
         builder.userInfoUri("https://www.googleapis.com/oauth2/v3/userinfo");
         builder.userNameAttributeName(IdTokenClaimNames.SUB);
         builder.clientName("Google");
         return builder;
      }

   },

   GITHUB {

      @Override
      public Builder getBuilder(String registrationId) {
         ClientRegistration.Builder builder = getBuilder(registrationId,
               ClientAuthenticationMethod.CLIENT_SECRET_BASIC, DEFAULT_REDIRECT_URL);
         builder.scope("read:user");
         builder.authorizationUri("https://github.com/login/oauth/authorize");
         builder.tokenUri("https://github.com/login/oauth/access_token");
         builder.userInfoUri("https://api.github.com/user");
         builder.userNameAttributeName("id");
         builder.clientName("GitHub");
         return builder;
      }

   },

   FACEBOOK {

      @Override
      public Builder getBuilder(String registrationId) {
         ClientRegistration.Builder builder = getBuilder(registrationId,
               ClientAuthenticationMethod.CLIENT_SECRET_POST, DEFAULT_REDIRECT_URL);
         builder.scope("public_profile", "email");
         builder.authorizationUri("https://www.facebook.com/v2.8/dialog/oauth");
         builder.tokenUri("https://graph.facebook.com/v2.8/oauth/access_token");
         builder.userInfoUri("https://graph.facebook.com/me?fields=id,name,email");
         builder.userNameAttributeName("id");
         builder.clientName("Facebook");
         return builder;
      }

   },

   OKTA {

      @Override
      public Builder getBuilder(String registrationId) {
         ClientRegistration.Builder builder = getBuilder(registrationId,
               ClientAuthenticationMethod.CLIENT_SECRET_BASIC, DEFAULT_REDIRECT_URL);
         builder.scope("openid", "profile", "email");
         builder.userNameAttributeName(IdTokenClaimNames.SUB);
         builder.clientName("Okta");
         return builder;
      }

   };

   private static final String DEFAULT_REDIRECT_URL = "{baseUrl}/{action}/oauth2/code/{registrationId}";

   protected final ClientRegistration.Builder getBuilder(String registrationId, ClientAuthenticationMethod method,
         String redirectUri) {
      ClientRegistration.Builder builder = ClientRegistration.withRegistrationId(registrationId);
      builder.clientAuthenticationMethod(method);
      builder.authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE);
      builder.redirectUri(redirectUri);
      return builder;
   }

   /**
    * Create a new
    * {@link org.springframework.security.oauth2.client.registration.ClientRegistration.Builder
    * ClientRegistration.Builder} pre-configured with provider defaults.
    * @param registrationId the registration-id used with the new builder
    * @return a builder instance
    */
   public abstract ClientRegistration.Builder getBuilder(String registrationId);

}
```

ì´ê³³ì— ëª…ì‹œëœ ì†Œì…œ ë¡œê·¸ì¸ì´ ì•„ë‹Œ ë‹¤ë¥¸ ë°©ì‹(ë„¤ì´ë²„, ì¹´ì¹´ì˜¤ ë“±)ì„ ì¶”ê°€í•œë‹¤ë©´ ì§ì ‘ ë‹¤ ì¶”ê°€í•´ ì£¼ì–´ì•¼ í•œë‹¤. ì´ì ì„ ê¸°ì–µí•´ í•´ë‹¹ ë¸”ë¡œê·¸ì—ì„œ ì–´ë–¤ ë°©ì‹ì„ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸ í›„ ì°¸ê³ í•˜ë„ë¡ í•˜ì.

<br/>

<br/>

## êµ¬ê¸€ ì„œë¹„ìŠ¤ ë“±ë¡

[êµ¬ê¸€ í´ë¼ìš°ë“œ í”Œë«í¼](https://console.cloud.google.com)ìœ¼ë¡œ ì´ë™í•œë‹¤

![image-20211122160459855](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122160459855.png)

##### í”„ë¡œì íŠ¸ ì„ íƒì„ í´ë¦­í•œë‹¤.

<br/>

![image-20211122160655837](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122160655837.png)

##### [ìƒˆ í”„ë¡œì íŠ¸] ë²„íŠ¼ì„ í´ë¦­í•œë‹¤.

<br/>

![image-20211122160912398](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122160912398.png)

##### ë“±ë¡ë  ì„œë¹„ìŠ¤ì˜ ì´ë¦„ì„ ì…ë ¥í•œë‹¤. ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ì§€ìœ¼ë©´ ë˜ê³ , ë‚˜ëŠ” social-login-google-testë¡œ ì§€ì—ˆë‹¤. ìœ„ì¹˜ëŠ” ì¡°ì§ ì—†ìŒìœ¼ë¡œ í•´ì£¼ì—ˆë‹¤.

<br/>

![image-20211122161028672](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122161028672.png)

##### ìƒì„±ì´ ì™„ë£Œë˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì°½ì´ ëœ° ê²ƒì´ë‹¤.(ì§„ì§œ ë˜‘ê°™ì´ ë³´ì—¬ì£¼ë ¤ê³  ì „ì²´ í™”ë©´ì„ ìº¡ì³í–ˆë‹¤..) API ë° ì„œë¹„ìŠ¤ë¥¼ í´ë¦­í•˜ì. 

<br/>

![image-20211122161418097](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122161418097.png)

##### [ì‚¬ìš©ì ì¸ì¦ ì •ë³´]ë¥¼ í´ë¦­ í›„ [ì‚¬ìš©ì ì¸ì¦ ì •ë³´ ë§Œë“¤ê¸°] ë²„íŠ¼ì„ í´ë¦­í•œë‹¤.

##### ì´í›„ [OAuth í´ë¼ì´ì–¸íŠ¸ ID]ë¥¼ í´ë¦­í•˜ì.

<br/>

![image-20211122161507958](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122161507958.png)

##### [ë™ì˜ í™”ë©´ êµ¬ì„±]ì„ í´ë¦­í•˜ì

<br/>

![image-20211122161620565](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122161620565.png)

##### ì—¬ê¸°ì„œë¶€í„° ì±…ê³¼ ì¡°ê¸ˆ ë‹¬ëë‹¤. ìš°ì„  ìš°ë¦¬ëŠ” ì¡°ì§ ë‚´ ì‚¬ìš©ìë§Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, ì•„ë¬´ ì‚¬ëŒì´ë‚˜ êµ¬ê¸€ ê³„ì •ì„ ê°€ì§€ê³  ìˆìœ¼ë©´ ë¡œê·¸ì¸ì„ í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ ê²ƒì´ê¸° ë•Œë¬¸ì— ì™¸ë¶€ë¡œ í•˜ëŠ” ê²ƒì´ ë§ë‹¤ê³  íŒë‹¨í•˜ì—¬ ì™¸ë¶€ë¥¼ ì„ íƒí–ˆë‹¤. ì´ ê¸€ì„ ë³´ëŠ” ì—¬ëŸ¬ë¶„ë“¤ë„ ì™¸ë¶€ë¥¼ í´ë¦­í•˜ê³  ë§Œë“¤ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì.

<br/>

![image-20211122162610523](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122162610523.png)

##### ë¨¼ì € ì•± ì •ë³´ì´ë‹¤.

- ì•± ì´ë¦„ : êµ¬ê¸€ ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œë  ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„ì„ ì´ì•¼ê¸°í•œë‹¤.
- ì‚¬ìš©ì ì§€ì› ì´ë©”ì¼: ì‚¬ìš©ì ë™ì˜ í™”ë©´ì—ì„œ ë…¸ì¶œë  ì´ë©”ì¼ ì£¼ì†Œì´ë‹¤. ë³´í†µì€ ì„œë¹„ìŠ¤ì˜ help ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” ê·¸ëƒ¥ ìš°ë¦¬ë“¤ì˜ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

<br/>

![image-20211122163319434](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122163319434.png)

##### ì´ê²ƒë“¤ì€ ì•„ì§ ì˜ ëª¨ë¥´ê² ë‹¤... ìš°ì„  ìš°ë¦¬ëŠ” í…ŒìŠ¤íŠ¸ë§Œ í• ê±°ë‹ˆê¹Œ ê³µë°±ìœ¼ë¡œ ë‘ê³  ë„˜ì–´ê°€ì

##### ê°œë°œì ì—°ë½ì²˜ ì •ë³´ì—ëŠ” ìì‹ ì´ ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ” ì´ë©”ì¼ì„ ì ì–´ì£¼ë„ë¡ í•˜ì.

##### ì‘ì„±í–ˆë‹¤ë©´ [ì €ì¥ í›„ ê³„ì†]ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì.

<br/>

![image-20211122163854202](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122163854202.png)

##### ëª¨ë¥´ê² ë‹¤. ë¹ˆì¹¸ìœ¼ë¡œ ë‘ê³  [ì €ì¥ í›„ ê³„ì†]ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì.

<br/>

![image-20211122163935257](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122163935257.png)

##### ëª¨ë¥´ê² ë‹¤. ë¹ˆì¹¸ìœ¼ë¡œ ë‘ê³  [ì €ì¥ í›„ ê³„ì†]ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì.

<br/>

![image-20211122164232363](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122164232363.png)

##### ì™„ë£Œë˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ìš”ì•½ì´ ëœ°ê²ƒì¸ë° ë§¨ ì•„ë˜ [ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì.

<br/>

##### ì´ì œ OAuth2 í´ë¼ì´ì–¸íŠ¸ IDë¥¼ ë°œê¸‰ë°›ì„ ì°¨ë¡€ì´ë‹¤. ë‹¤ì‹œ ì²˜ìŒê³¼ ê°™ì´ [ì‚¬ìš©ì ì¸ì¦ ì •ë³´]ë¡œ ë“¤ì–´ê°€ì„œ [ì‚¬ìš©ì ì¸ì¦ ì •ë³´ ë§Œë“¤ê¸°]ë¥¼ í´ë¦­ í›„ [OAuth í´ë¼ì´ì–¸íŠ¸ ID]ë¥¼ í´ë¦­í•˜ì.

![image-20211122164455068](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122164455068.png)

<br/>

![image-20211122164711612](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122164711612.png)

- ##### ì• í”Œë¦¬ì¼€ì´ì…˜ ìœ í˜• : ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜

- ##### ì´ë¦„ : ë§˜ëŒ€ë¡œ ì§€ì–´ì£¼ì.

#### ìŠ¹ì¸ëœ ë¦¬ë””ë ‰ì…˜ URI

- ì„œë¹„ìŠ¤ì—ì„œ íŒŒë¼ë¯¸í„°ë¡œ ì¸ì¦ ì •ë³´ë¥¼ ì£¼ì—ˆì„ ë•Œ ì¸ì¦ì´ ì„±ê³µí•˜ë©´ êµ¬ê¸€ì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•   URLì´ë‹¤.

- ìŠ¤í”„ë§ ë¶€íŠ¸ 2 ë²„ì „ì˜ ì‹œíë¦¬í‹°ì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ 

  ##### [ë„ë©”ì¸]/login/oauth2/code/{ì†Œì…œì„œë¹„ìŠ¤ì½”ë“œ}

  ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì„ ì§€ì›í•˜ê³  ìˆë‹¤.

- ì‚¬ìš©ìê°€ ë³„ë„ë¡ ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì„ ì§€ì›í•˜ëŠ” Controllerë¥¼ ë§Œë“¤ í•„ìš”ê°€ ì—†ë‹¤. ì‹œíë¦¬í‹°ì—ì„œ ì´ë¯¸ êµ¬í˜„í•´ ë†“ì€ ìƒíƒœì´ë‹¤.

- í˜„ì¬ëŠ” ê°œë°œ ë‹¨ê³„ì´ë¯€ë¡œ http://localhost:8080/login/oauth2/code/googleë¡œë§Œ ë“±ë¡í•œë‹¤.

- ì´í›„ AWS ì„œë²„ì— ë°°í¬í•˜ê²Œ ë˜ë©´ localhostì™¸ì— ì¶”ê°€ë¡œ ì£¼ì†Œë¥¼ ì¶”ê°€í•´ì•¼ í•˜ë©°, ì´ê±´ ì´í›„ ë‹¨ê³„ì—ì„œ ì§„í–‰í•œë‹¤.

##### ë‹¤ ì‘ì„±í•˜ì˜€ë‹¤ë©´  ë§¨ ì•„ë˜ [ë§Œë“¤ê¸°] ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì.

<br/>

![image-20211122165323025](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122165323025.png)

ì™„ë£Œëë‹¤. ìœ„ ì°½ì—ì„œ í´ë¼ì´ì–¸íŠ¸ IDì™€ ë³´ì•ˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê°€ì§€ê³  ìˆì.

##### ì´ëŠ” ì ˆëŒ€ ì™¸ë¶€ë¡œ ìœ ì¶œë˜ì–´ì„œëŠ” ì•ˆëœë‹¤.

ì´ í™”ë©´ì—ì„œ ì‹¤ìˆ˜ë¡œ ë³µì‚¬ë¥¼ ëª»í–ˆì–´ë„ ìƒê´€ì—†ë‹¤. ë‹¤ì‹œ í™•ì¸í•  ìˆ˜ ìˆë‹¤!

<br/>

<br/>

### application-oauth.properties ë“±ë¡

application.propertiesì™€ ë™ì¼í•œ ê²½ë¡œì— application-oauth.properties íŒŒì¼ì„ ìƒì„±í•´ì£¼ì.

![image-20211122165923483](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122165923483.png)

<br/>

![image-20211122170311160](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122170311160.png)

```properties
spring.security.oauth2.client.registration.google.client-id=í´ë¼ì´ì–¸íŠ¸ ID
spring.security.oauth2.client.registration.google.client-secret=í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ ë¹„ë°€ë²ˆí˜¸
spring.security.oauth2.client.registration.google.scope=profile,email
```

- ##### ë§ì€ ì˜ˆì œì—ì„œëŠ” ì´ scopeë¥¼ ë³„ë„ë¡œ ë“±ë¡í•˜ì§€ ì•Šê³  ìˆë‹¤.

- ##### ê¸°ë³¸ê°’ì´ openid, profile, emailì´ê¸° ë•Œë¬¸ì´ë‹¤.

- ##### profile, emailë¥¼ ê°•ì œë¡œ ë“±ë¡í•œ ì´ìœ ëŠ” openidë¼ëŠ” scopeê°€ ìˆìœ¼ë©´ Open Id Providerë¡œ ì¸ì‹í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

- ##### ì´ë ‡ê²Œ ë˜ë©´ OpenId Providerì¸ ì„œë¹„ìŠ¤(êµ¬ê¸€)ì™€ ê·¸ë ‡ì§€ ì•Šì€ ì„œë¹„ìŠ¤(ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ ë“±)ë¡œ ë‚˜ëˆ ì„œ ê°ê° OAuth2Serviceë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤.

- ##### í•˜ë‚˜ì˜ OAuth2Serviceë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì¼ë¶€ëŸ¬ openid scopeë¥¼ ë¹¼ê³  ë“±ë¡í•œë‹¤.

<br/>

##### ìŠ¤í”„ë§ ë¶€íŠ¸ì—ì„œëŠ” propertiesì˜ ì´ë¦„ì„ application-xxx.propertiesë¡œ ë§Œë“¤ë©´ xxxë¼ëŠ” ì´ë¦„ì˜ profileì´ ìƒì„±ë˜ì–´ ì´ë¥¼ í†µí•´ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.

##### ì¦‰ profile=xxxë¼ëŠ” ì‹ìœ¼ë¡œ í˜¸ì¶œí•˜ë©´ í•´ë‹¹ propertiesì˜ ì„¤ì •ë“¤ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

í˜¸ì¶œí•˜ëŠ” ë°©ì‹ì—ëŠ” ì—¬ëŸ¬ ë°©ì‹ì´ ìˆì§€ë§Œ ì´ ì±…ì—ì„œëŠ”(ì´ ê¸€ì—ì„œëŠ”)ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ê¸°ë³¸ ì„¤ì • íŒŒì¼ì¸ application.propertiesì—ì„œ application-oauth.propertiesë¥¼ í¬í•¨í•˜ë„ë¡ êµ¬ì„±í•œë‹¤.

<br/>

##### application.propertiesì— ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œ ì¶”ê°€.

```properties
spring.profiles.include=oauth
```

<br/>

### .gitignore ë“±ë¡

êµ¬ê¸€ ë¡œê·¸ì¸ì„ ìœ„í•œ í´ë¼ì´ì–¸íŠ¸IDì™€ í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ë³´ì•ˆì´ ì¤‘ìš”í•œ ì •ë³´ë“¤ì´ë‹¤.

ì´ë“¤ì´ ì™¸ë¶€ì— ë…¸ì¶œë  ê²½ìš° ì–¸ì œë“  ê°œì¸ì •ë³´ë¥¼ ê°€ì ¸ê°ˆ ìˆ˜ ìˆëŠ” ì·¨ì•½ì ì´ ë  ìˆ˜ ìˆë‹¤.

ê¹ƒí—ˆë¸Œì™€ ì—°ë™í•´ì„œ applicaiton-oauth.properties íŒŒì¼ì„ ì˜¬ë¦´ ê²½ìš° ë¬¸ì œê°€ ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ .gitignoreíŒŒì¼ì— ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•œë‹¤.

```properties
applicaion-oauth.properties
```

![image-20211122172008640](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122172008640.png)

##### ì„¤ì •í–ˆë‹¤ë©´ ì»¤ë°‹ í›„ í‘¸ì‰¬í•´ë³´ì.

[gitignoreê°€ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´](https://jojoldu.tistory.com/307)

<br/>

<br/>

## êµ¬ê¸€ ë¡œê·¸ì¸ ì—°ë™í•˜ê¸°

ì‚¬ìš©ì ì •ë³´ë¥¼ ë‹´ë‹¹í•  User í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ì.

domain íŒ¨í‚¤ì§€ ì•„ë˜ì— useríŒ¨í‚¤ì§€ë¥¼ ìƒì„±í•´ì„œ ë§Œë“¤ì.

![image-20211122174608340](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122174608340.png)

<br/>

```java
package web.purplebook.domain.user;

import lombok.AccessLevel;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import web.purplebook.domain.BaseTimeEntity;

import javax.persistence.*;

@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Entity
public class User extends BaseTimeEntity {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "USER_ID")
    private Long id;

    @Column(unique = true)
    private String username;

    @Column(nullable = false)
    private String name;

    @Column(nullable = false)
    private String email;

    private String picture;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private Role role;

    @Builder
    public User( String name, String username,String email, String picture, Role role) {
        this.name = name;
        this.username = username;
        this.email = email;
        this.picture = picture;
        this.role = role;
    }
    public User update(String name, String picture){
        this.name = name;
        this.picture = picture;
        return this;
    }

    public String getRoleKey() {
        return this.role.getKey();
    }


    public void googleSignUp(String username){
        this.username = username;
        this.role = Role.USER;
    }
}


```

##### googleSignUp

- ì±…ì—ëŠ” ì—†ê³  ë‚˜ í˜¼ì ì¶”ê°€í•œ ì½”ë“œì´ë‹¤.
- ì¡°ê¸ˆ ì´ë”°ê°€ êµ¬ê¸€ì„ í†µí•œ ì •ë³´ ì œê³µ ë™ì˜ í›„, ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥ë°›ì•„ íšŒì›ê°€ì…ì„ ì§„í–‰í•  ë•Œ ì‚¬ìš©ëœë‹¤.

<br/>

<br/>

##### Role í´ë˜ìŠ¤ ìƒì„±

```java
package web.purplebook.domain.user;

import lombok.Getter;
import lombok.RequiredArgsConstructor;

@Getter
@RequiredArgsConstructor
public enum Role {

    GUEST("ROLE_GUEST","ì†ë‹˜"),
    USER("ROLE_USER","ì¼ë°˜ ì‚¬ìš©ì"),
    ADMIN("ROLE_ADMIN", "ê´€ë¦¬ì");

    private final String key;
    private final String title;

}
```

##### ì±…ì—ì„œëŠ” ADMIN ì—­í• ì€ ë¶€ì—¬í•˜ì§€ ì•Šì•˜ìœ¼ë‚˜ ì„ì˜ë¡œ ìƒì„±í•˜ì˜€ë‹¤.

##### ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œëŠ” ê¶Œí•œ ì½”ë“œì— í•­ì‚¬ ROLE_ì´ ì•ì— ìˆì–´ì•¼ë§Œ í•œë‹¤.(ê·¼ë° í•„ìê°€ ë©°ì¹  ì „ ëŒ€íšŒì—ì„œ ê¶Œí•œì„ ë¶€ì—¬í•  ë•ŒëŠ” ROLE\_ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  í•˜ì˜€ëŠ”ë°ë„, ê¶Œí•œì´ ì˜ ì‘ë™í–ˆì—ˆëŠ”ë° ë‚˜ì¤‘ì— ì•Œì•„ë´ì•¼ê² ë‹¤.)

<br/>

##### UserRepository ìƒì„±

```java
package web.purplebook.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import web.purplebook.domain.user.User;

import java.util.Optional;

public interface UserRepository extends JpaRepository<User, Long> {

    Optional<User> findByUsername(String username);
    Optional<User> findByEmail(String email);
}

```

<br/>

<br/>

### ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì˜ì¡´ì„± ì¶”ê°€

```properties
implementation 'org.springframework.boot:spring-boot-starter-security'
implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
```

```properties
plugins {
   id 'org.springframework.boot' version '2.6.0'
   id 'io.spring.dependency-management' version '1.0.11.RELEASE'
   id 'java'
}

group = 'web'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '17'

repositories {
   mavenCentral()
}

dependencies {
   implementation 'org.springframework.boot:spring-boot-starter'
   testImplementation 'org.springframework.boot:spring-boot-starter-test'

   //Spring Data JPA ì¶”ê°€
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    //h2 ë°ì´í„°ë² ì´ìŠ¤ ì¶”ê°€
    runtimeOnly 'com.h2database:h2'


   //íƒ€ì„ë¦¬í”„ ì¶”ê°€
   implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'

   implementation 'org.springframework.boot:spring-boot-starter-web'

   //ì‹œíë¦¬í‹° ì¶”ê°€
   implementation 'org.springframework.boot:spring-boot-starter-security'
   implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'

   compileOnly 'org.projectlombok:lombok'
   annotationProcessor 'org.projectlombok:lombok'

   //í…ŒìŠ¤íŠ¸ì—ì„œ lombok ì‚¬ìš©
   testCompileOnly 'org.projectlombok:lombok'
   testAnnotationProcessor 'org.projectlombok:lombok'
}

test {
   useJUnitPlatform()
}
```

##### ì „ì²´ gradleì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

##### ì±…ì—ì„œëŠ” oauth2-clientì—†ì´ë„ ì˜ ì‘ë™í•˜ì˜€ì§€ë§Œ ë²„ì „ì´ ì—…ë°ì´íŠ¸ ë˜ë©´ì„œ ë°”ë€ ê²ƒ ê°™ë‹¤.

<br/>

#### config.authíŒ¨í‚¤ì§€ ìƒì„±

ì•ìœ¼ë¡œ ì‹œíë¦¬í‹° ê´€ë ¨ í´ë˜ìŠ¤ëŠ” ëª¨ë‘ ì´ê³³ì— ë‹´ì•„ì„œ ê´€ë¦¬í•  ê²ƒì´ë‹¤.

![image-20211122180213367](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122180213367.png)

<br/>

### SecurityConfig í´ë˜ìŠ¤ ì‘ì„±

CustomOAuth2UserService í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì§€ ì•Šì•„ ì»´íŒŒì¼ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ë§Œ, ìš°ì„  ì‘ì„±í•˜ê³  ì´í›„ì— ì¶”ê°€í•˜ê² ë‹¤.

##### ì°¸ê³ 

- ì‘ì„± ì¤‘ íŒì„ ì£¼ìë©´ ctrl + oë¥¼ ëˆŒëŸ¬ì„œ Overrideí•  ë©”ì†Œë“œë¥¼ ì„ íƒí•  ìˆ˜ ìˆë‹¤

![image-20211122180800369](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122180800369.png)

<br/>

#### SecurityConfig ìƒì„±

<script src="https://gist.github.com/ShinDongHun1/5de105c91becdc363bbca9b2a7cdef31.js"></script>

<br/>

#### CustomOAuth2UserService ìƒì„±

<script src="https://gist.github.com/ShinDongHun1/cf7734c660b7e4384060f9a013c1a34a.js"></script>

##### registrationId 

- í˜„ì¬ ë¡œê·¸ì¸ ì§„í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ë¥¼ êµ¬ë¶„í•˜ëŠ” ì½”ë“œ. ì§€ê¸ˆì€ êµ¬ê¸€ë§Œ ì‚¬ìš©í•˜ì—¬ í•„ìš”ê°€ ì—†ìœ¼ë‚˜ ì´í›„ ë„¤ì´ë²„, ì¹´ì¹´ì˜¤ ë“± ì—°ë™ ì‹œì— êµ¬ë¶„ì„ ìœ„í•´ ì‚¬ìš©í•œë‹¤.

##### userNameAttributeName

- OAuth2 ë¡œê·¸ì¸ ì§„í–‰ ì‹œ í‚¤ê°€ ë˜ëŠ” í•„ë“œê°’. Primary Keyì™€ ê°™ì€ ì˜ë¯¸.
- êµ¬ê¸€ì˜ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œëŠ” ì½”ë“œë¥¼ ì§€ì›í•˜ì§€ë§Œ, ë„¤ì´ë²„, ì¹´ì¹´ì˜¤ ë“±ì€ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤. êµ¬ê¸€ì˜ ê¸°ë³¸ ì½”ë“œëŠ” **"sub"** ì´ë‹¤
- ì´í›„ ë„¤ì´ë²„ ë¡œê·¸ì¸ê³¼ êµ¬ê¸€ ë¡œê·¸ì¸ì„ ë™ì‹œ ì§€ì›í•  ë•Œ ì‚¬ìš©ëœë‹¤.

##### OAuthAttributes

- OAuth2UserService ë¥¼ í†µí•´ ê°€ì ¸ì˜¨ OAuth2Userì˜ attributeë¥¼ ë‹´ì„ í´ë˜ìŠ¤ì´ë‹¤.
- ì´í›„ ë„¤ì´ë²„ ë“± ë‹¤ë¥¸ ì†Œì…œ ë¡œê·¸ì¸ë„ ì´ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•œë‹¤.
- ì´ ë‹¤ìŒì— ì´ í´ë˜ìŠ¤ë¥¼ ì‘ì„±í•  ê²ƒì´ë‹ˆ ì§€ê¸ˆì€ ì˜¤ë¥˜ê°€ ë‚˜ë„ ë„˜ì–´ê°€ì.

##### SessionUser

- ì„¸ì…˜ì— ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ Dto í´ë˜ìŠ¤ì´ë‹¤. 
- ì™œ User í´ë˜ìŠ¤ë¥¼ ì“°ì§€ ì•Šê³  Dtoë¥¼ ìƒˆë¡œ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•˜ëŠ”ì§€ëŠ” ì´í›„ì— ì„¤ëª…í•˜ê² ë‹¤

> ##### ì°¸ê³  
>
> ë‚˜ëŠ” Rest API ë°©ì‹ìœ¼ë¡œ ì´í›„ í”„ë¡œì íŠ¸ë“¤ì„ ì§„í–‰í•˜ê³  ì‹¶ë‹¤. ë”°ë¼ì„œ ì„¸ì…˜ì„ ì“¸ ìƒê°ì´ ì—†ì§€ë§Œ, ì•„ì§ì€ ì„¸ì…˜ì„ ì•ˆ ì“°ê³  ì–´ë–»ê²Œ êµ¬í˜„í•´ì•¼ í•  ì§€ ëª¨ë¥´ê¸° ë•Œë¬¸ì— ìš°ì„ ì„ ì±…ì„ ë”°ë¼ ì„¸ì…˜ì„ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„í•  ìƒê°ì´ë‹¤. ì´í›„ ì„¸ì…˜ ì—†ì´ ì–´ë–»ê²Œ êµ¬í˜„í•˜ëŠ” ì§€ì— ëŒ€í•´ì„œëŠ” ê³µë¶€ í›„ ë”°ë¡œ ì—…ë¡œë“œ í•˜ê² ë‹¤.

<br/>

#### <span style="color:red">ì°¸ê³ </span>

##### êµ¬ê¸€ì˜ ê²½ìš° emailì„ í•„ìˆ˜ ì œê³µ ì •ë³´ë¡œ ë“±ë¡í•˜ë©°, ì´ëŠ” ê²¹ì¹˜ì§€ ì•ŠëŠ”ë‹¤ ë”°ë¼ì„œ findByEmailì„ í†µí•´ íŠ¹ì • íšŒì›ì„ ì‹ë³„í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë‚˜ ì¹´ì¹´ì˜¤ì˜ ê²½ìš° emailì„ ì œê³µí•˜ì§€ ì•Šì„ìˆ˜ë„ ìˆë‹¤. ë”°ë¼ì„œ ì¹´ì¹´ì˜¤ì˜ ê²½ìš° ì¹´ì¹´ì˜¤ì—ì„œ ì œê³µí•˜ëŠ” kakaoIdë¥¼ í†µí•´ ë”°ë¡œ ì‹ë³„í•˜ë„ë¡ ì½”ë“œë¥¼ ì‘ì„±í•˜ì—¬ì•¼ í•œë‹¤.

<br/>

#### OAuthAttributes í´ë˜ìŠ¤ ìƒì„±

OAuthAttributes ëŠ” Dtoê¸° ë•Œë¬¸ì— config/auth/dto íŒ¨í‚¤ì§€ë¥¼ ìƒì„±í•˜ì—¬ ì¶”ê°€í•´ì¤€ë‹¤.

![image-20211122184214726](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122184214726.png)



<script src="https://gist.github.com/ShinDongHun1/ab56945bd9ecb0e241f9f21ea18d5990.js"></script>

##### of

- OAuth2Userì—ì„œ ë°˜í™˜í•˜ëŠ” ì‚¬ìš©ì ì •ë³´ëŠ” Map ì´ê¸° ë•Œë¬¸ì— ê°’ í•˜ë‚˜í•˜ë‚˜ë¥¼ ë³€í™˜í•´ì•¼ë§Œ í•œë‹¤.

##### toEntity()

- User ì—”í‹°í‹°ë¥¼ ìƒì„±í•œë‹¤
- OAuthAttributesì—ì„œ ì—”í‹°í‹°ë¥¼ ìƒì„±í•˜ëŠ” ì‹œì ì€ ì²˜ìŒ ê°€ì…í•  ë•Œì´ë‹¤.
- ê°€ì…í•  ë•Œì˜ ê¸°ë³¸ ê¶Œí•œì„ GUESTë¡œ ì£¼ê¸° ìœ„í•´ì„œ role ë¹Œë”ê°’ì—ëŠ” Role.GUESTë¥¼ ì‚¬ìš©í•œë‹¤.
- OAuthAttributes í´ë˜ìŠ¤ ìƒì„±ì´ ëë‚¬ìœ¼ë©´ ê°™ì€ íŒ¨í‚¤ì§€ì— SessionUser í´ë˜ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.

<br/>

#### SessionUser ìƒì„±

```java
package web.purplebook.config.auth.dto;

import lombok.Getter;
import web.purplebook.domain.user.User;

import java.io.Serializable;

@Getter
public class SessionUser implements Serializable {

    private Long id;
    private String name;
    private String username;
    private String email;
    private String picture;


    public SessionUser(User user) {
        this.id = user.getId();
        this.name = user.getName();
        this.username = user.getUsername();
        this.email = user.getEmail();
        this.picture = user.getPicture();
    }
}

```

<br/>

<br/>

#### ì™œ User í´ë˜ìŠ¤ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šë‚˜ìš”?

Userí´ë˜ìŠ¤ë¥¼ ì„¸ì…˜ì— ì €ì¥í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤ë©´ **ì§ë ¬í™”ë¥¼ êµ¬í˜„í•´ì•¼ í•œë‹¤.**

ê·¸ëŸ¬ë‚˜ User í´ë˜ìŠ¤ëŠ” ì—”í‹°í‹°ì´ê¸° ë•Œë¬¸ì— ì–¸ì œ ë‹¤ë¥¸ ì—”í‹°í‹°ì™€ ê´€ê³„ê°€ í˜•ì„±ë ì§€ ëª¨ë¥¸ë‹¤.

ë‹¤ë¥¸ ì—”í‹°í‹°ì™€ ê´€ê³„ê°€ í˜•ì„±ëœë‹¤ë©´(ì˜ˆë¥¼ ë“¤ì–´ @OneToMany, @ManyToOne) ì§ë ¬í™” ëŒ€ìƒì— ì´ë“¤ê¹Œì§€ í¬í•¨ë˜ì–´ ì„±ëŠ¥ ì´ìŠˆ, ë¶€ìˆ˜ íš¨ê³¼ê°€ ë°œìƒí•  í™•ë¥ ì´ ë†’ë‹¤.

ë”°ë¼ì„œ ì§ë ¬í™” ê¸°ëŠ¥ì„ ê°€ì§„ ì„¸ì…˜ Dtoë¥¼ í•˜ë‚˜ ì¶”ê°€ë¡œ ë§Œë“œëŠ” ê²ƒì´ ì´í›„ ìš´ì˜ ë° ìœ ì§€ë³´ìˆ˜ ë•Œ ë§ì€ ë„ì›€ì´ ëœë‹¤.

<br/>

<br/>

### í™”ë©´ êµ¬ì„±í•˜ê¸°

##### index.html ì¶”ê°€

```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header">
    <title>Hello</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>

<body>
    <h1>ìŠ¤í”„ë§ ë¶€íŠ¸ë¡œ ì‹œì‘í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤</h1>
    <div class="col-md-12">
        <div class="row">
            <div class="col-md-6">
                <a href="/posts/save" role="button" class="btn btn-primary">ê¸€ë“±ë¡</a>
            </div>
        </div>
        <br/>
        <!-- ë¡œê·¸ì¸ ê¸°ëŠ¥ -->
        <span id="user" th:if="${not #strings.isEmpty(username)}" th:text="${username}"></span>
        <a href="/logout"class="btn btn-info active" role="button" th:if="${not #strings.isEmpty(username)}">Logout</a>

        <a href="/oauth2/authorization/google"class="btn btn-success active" role="button" th:unless="${not #strings.isEmpty(username)}">Google Login</a>

        <!-- ëª©ë¡ ì¶œë ¥ ì˜ì—­ -->
        <table class="table table-horizontal table-bordered">
            <thead class="thead-strong">
            <tr>
                <th>ê²Œì‹œê¸€ë²ˆí˜¸</th>
                <th>ì œëª©</th>
                <th>ì‘ì„±ì</th>
                <th>ìµœì¢…ìˆ˜ì •ì¼</th>
            </tr>
            </thead>

            <tbody id="tbody">
                <tr th:each="post : ${posts}">
                    <td th:text="${post.id}"></td>
                    <td>
                        <a href="#" th:href="@{/posts/update/{id} (id=${post.id})}" th:text="${post.title}">ìˆ˜ì •</a>
                    </td>
                    <td th:text="${post.author}"></td>
                    <td th:text="${post.modifiedDate}"></td>
                    <td>
                        <a href="#" th:href="@{/posts/update/{id} (id=${post.id})}" class="btn btn-primary" role="button">ìˆ˜ì •</a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div th:replace="fragments/footer :: footer" />
</body>
</html>

```

<br/>

##### IndexController ìˆ˜ì •

```java
package web.purplebook.web;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import web.purplebook.config.auth.dto.SessionUser;
import web.purplebook.service.posts.PostsService;
import web.purplebook.web.dto.PostsResponseDto;

import javax.servlet.http.HttpSession;

@Controller
@RequiredArgsConstructor
public class IndexController {

    private final PostsService postsService;
    private final HttpSession httpSession;

    @GetMapping("/")
    public String index(Model model){
        model.addAttribute("posts", postsService.findAllDesc());

        SessionUser user = (SessionUser) httpSession.getAttribute("user");
        if(user != null && user.getUsername() != null){
            model.addAttribute("username", user.getName());
        }

        return "index";
    }

    @GetMapping("/posts/save")
    public String postsSave(){
        return "posts-save";
    }


    @GetMapping("/posts/update/{id}")
    public String postsUpdate(@PathVariable("id")Long id, Model model) {
        PostsResponseDto dto = postsService.findById(id);
        model.addAttribute("post",dto);
        return "posts-update";
    }

}

```

ì±…ì—ì„œì™€ ë‹¬ë¦¬ user.getUsername() != null ì¡°ê±´ì„ ë„£ì–´ì„œ ë™ì˜ë§Œ í•˜ê³  ê°€ì…ì€ ì•ˆ í•œ ìƒíƒœì¼ ê²½ìš°ì—ëŠ” ë¬´ì‹œí•˜ë„ë¡ ë§Œë“¤ì—ˆë‹¤.

<br/>

![image-20211122200914743](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122200914743.png)

![image-20211122200924872](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211122200924872.png)

<br/>

<br/>

### ì œê³µí•˜ëŠ” ì •ë³´ ì™¸ì— ì¶”ê°€ ì •ë³´ ì…ë ¥

##### ìœ„ ë‚´ìš©ì€ ì±…ì— ì—†ìœ¼ë©° í˜¼ìì„œ ì—´ì‹œë¯¸ ì´ê²ƒì €ê²ƒ ìƒê°í•´ë³´ë©° ë§Œë“¤ì—ˆë‹¤.

```java
package web.purplebook.web;

import lombok.RequiredArgsConstructor;
import org.apache.catalina.authenticator.SpnegoAuthenticator;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Controller;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;
import web.purplebook.config.auth.dto.OAuth2SignUpDto;
import web.purplebook.config.auth.dto.SessionUser;
import web.purplebook.domain.user.User;
import web.purplebook.repository.UserRepository;

import javax.servlet.http.HttpSession;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

@Controller
@RequiredArgsConstructor
public class CustomOAuth2SignUpController {

    private final HttpSession httpSession;
    private final UserRepository userRepository;

    @GetMapping("/addform")
    public String addForm(Model model){
        SessionUser user = (SessionUser)httpSession.getAttribute("user");
        if(user.getUsername() != null){
            model.addAttribute("username", user.getName());
            return "index";//ì´ë¯¸ íšŒì›ê°€ì… í•œ ì‚¬ëŒì´ë¼ë©´ ë©”ì¸ í˜ì´ì§€ë¡œ
        }
        else {
            return "/add-form";
        }
    }



    //ì¶”ê°€ ì…ë ¥
    @PostMapping("/signUp")
    @ResponseBody
    @Transactional
    public Long signUp(@RequestBody OAuth2SignUpDto oAuth2SignUpDto){
        SessionUser user = (SessionUser)httpSession.getAttribute("user");
        Long id = user.getId();

        User user1 = userRepository.findById(id).orElse(null);
        user1.googleSignUp(oAuth2SignUpDto.getUsername());//ì„¤ëª… ì°¸ê³ 
        

        updateRole(user1);//ì„¤ëª… ì°¸ê³ 
        
        httpSession.setAttribute("user", new SessionUser(user1));
        return 0L;
    }

    private void updateRole(User user ) {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        List<GrantedAuthority> updatedAuthorities = new ArrayList<>();
        updatedAuthorities.add(new SimpleGrantedAuthority(user.getRoleKey()));
        Authentication newAuth = new UsernamePasswordAuthenticationToken(auth.getPrincipal(), auth.getCredentials(), updatedAuthorities);
        SecurityContextHolder.getContext().setAuthentication(newAuth);
    }
}

```

#####  public String addForm ì„ ë³´ë©´, SecurityConfigì—ì„œ 

```
.oauth2Login()
.defaultSuccessUrl("/addform")//ì¶”ê°€ ì •ë³´ ì…ë ¥
```

##### ì´ëŸ¬í•œ ì½”ë“œê°€ ìˆì—ˆì„ ê²ƒì´ë‹¤. ì´ ë•Œë¬¸ì— ì´ë¯¸ ì •ë³´ ì œê³µì— ë™ì˜ë¥¼ í•œ ì‚¬ëŒì´ë¼ë©´ /addformì˜ ì£¼ì†Œë¡œ ì ‘ì†í•˜ê²Œ ë˜ì–´ìˆë‹¤.

##### ì´ë•Œ ì ‘ì†í•˜ì˜€ì„ ë•Œ ê·¸ ì‚¬ëŒì´ ì´ë¯¸ íšŒì›ê°€ì…ì„ í•œ ì‚¬ëŒì¼ ìˆ˜ë„ ìˆê³ , ì •ë³´ ì œê³µì— ë™ì˜ë§Œ í•œ ì‚¬ëŒì¼ ìˆ˜ë„ ìˆë‹¤. ì´ë¥¼ user.getUsername() != null ë¥¼ í†µí•´ì„œ ê°€ë ¤ë‚¸ë‹¤.

##### íšŒì›ê°€ì…ì„ ì™„ë£Œí•˜ë ¤ë©´ usernameì„ ì¶”ê°€ë¡œ ì…ë ¥í•´ì•¼ í•œë‹¤.  ë”°ë¼ì„œ ì´ë¯¸ íšŒì›ê°€ì…ì„ í•œ ì‚¬ëŒì´ë¼ë©´ usernameì´ ì¡´ì¬í•œë‹¤!

<br/>

googleSignUp

<br/>

##### updateRole

- CustomOAuth2UserService ì—ì„œ loadUserë¥¼ í†µí•´ì„œ ê¶Œí•œì„ ìƒì„±í•  ë•Œ, íšŒì›ê°€ì…ì„ í•˜ì§€ ì•Šì€ ìƒíƒœë¼ë©´ Guestë¡œ ë§Œë“¤ì–´ì§„ë‹¤.(ì´ë¯¸ ê°€ì…ì„ í•œ ì‚¬ëŒì´ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆ„ë¥¸ ê²½ìš°ì—ëŠ” Userë¡œ ë§Œë“¤ì–´ ì§)
- ë§Œì•½ íšŒì›ê°€ì…ì„ ì„±ê³µì ìœ¼ë¡œ ì§„í–‰í•˜ì˜€ì„ ê²½ìš°ì—ëŠ” ê¶Œí•œì„ GUESTì—ì„œ USERë¡œ ë°”ê¿”ì£¼ì–´ì•¼ í•˜ëŠ”ë°, ìœ„ ë©”ì†Œë“œê°€ ë°”ë¡œ ê·¸ ì—­í• ì„ í•œë‹¤.

<br/>

<br/>

#### add-form

```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header">
    <title>ì†Œì…œ ë¡œê·¸ì¸ ì¶”ê°€ ì •ë³´ ì…ë ¥ì°½</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>
<h1>íšŒì›ê°€ì… ì¶”ê°€ ì •ë³´ ì…ë ¥</h1>

<div class="col-md-12">
    <div class="col-md-4">
        <form>
            <div class="form-group">
                <label for="username">ì•„ì´ë””</label>
                <input type="text" class="form-control" id="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>

        <a href="/" role="button" class="btn btn-secondary">ì·¨ì†Œ</a>

        <button type="button" class="btn btn-primary" id="btn-signUp">ê°€ì…</button>


    </div>
</div>


<div th:replace="fragments/footer :: footer" />
</body>
</html>
```

<br/>

##### index.js ì¶”ê°€

```javascript
var main = {
    init : function () {
        var _this = this;
        $('#btn-save').on('click', function (){
        _this.save();
        });

        $('#btn-update').on('click', function (){
            _this.update();
        });

        $('#btn-delete').on('click', function (){
            _this.delete();
        });

        $('#btn-signUp').on('click', function (){
            _this.signup();
        });
    },
    save : function () {
        var data = {
            title: $('#title').val(),
            author: $('#author').val(),
            content: $('#content').val()
        };

        $.ajax({
            type: 'POST',
            url: '/api/v1/posts',
            dataType: 'json',
            contentType:'application/json; charset=utf-8',
            data: JSON.stringify(data)
        }).done(function (){
            alert('ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/';
        }).fail(function (error){
            alert(JSON.stringify(error));
        });
    },

    update : function () {
        var data = {
            title: $('#title').val(),
            content: $('#content').val()
        };

        var id = $('#id').val();

        $.ajax({
            type: 'PUT',
            url: '/api/v1/posts/'+id,
            dataType: 'json',
            contentType:'application/json; charset=utf-8',
            data: JSON.stringify(data)
        }).done(function (){
            alert('ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/';
        }).fail(function (error){
            alert(JSON.stringify(error));
        });
    },


    delete : function () {

        var id = $('#id').val();

        $.ajax({
            type: 'DELETE',
            url: '/api/v1/posts/'+id,
            dataType: 'json',
            contentType:'application/json; charset=utf-8',
        }).done(function (){
            alert('ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/';
        }).fail(function (error){
            alert(JSON.stringify(error));
        });
    },




    signup : function () {

        var data = {
            username: $('#username').val(),
        };

        $.ajax({
            type: 'POST',
            url: '/signUp',
            dataType: 'json',
            contentType:'application/json; charset=utf-8',
            data: JSON.stringify(data)
        }).done(function (){
            alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/';

        }).fail(function (error){
            alert(JSON.stringify(error));
        });
    }


};

main.init();
```

<br/>

<br/>

### ì´ì œ ì‹¤í–‰í•´ë³´ì

![image-20211123005517762](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123005517762.png)

##### ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë™ì˜ë¥¼ í•˜ì§€ ì•Šì•˜ë‹¤ë©´, ì•„ê¹Œ ì € ìœ„ì—ì„œ ë³´ì•˜ë˜ ë™ì˜í•˜ëŠ” í™”ë©´ì´ ë‚˜ì˜¬ê²ƒì´ê³ , ì´ë¯¸ ë™ì˜ë¥¼ í•˜ì˜€ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ í˜ì´ì§€ë¡œ ì´ë™ëœë‹¤.

![image-20211123005533841](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123005533841.png)

<br/>

##### ê°€ì…ì„ ì™„ë£Œ ì‹œ

![image-20211123005616208](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123005616208.png)

ë‹¤ìŒê³¼ ê°™ì´ ë‚˜ì˜¨ë‹¤. ë¡œê·¸ì•„ì›ƒ ì´í›„ì— ë‹¤ì‹œ ë©”ì¸ í˜ì´ì§€ë¡œ ì ‘ì†í•´ë³´ì

ê·¸ëŸ¼ ë‹¤ì‹œ ë¡œê·¸ì¸ ì°½ì´ ëœ°ê²ƒì¸ë°, ì—¬ê¸°ì„œ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´

![image-20211123005659454](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123005659454.png)

##### ì¶”ê°€ì •ë³´ ì…ë ¥ í¼ ì—†ì´ ê³§ë°”ë¡œ ë¡œê·¸ì¸ì´ ë˜ëŠ”ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

![image-20211123005722486](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123005722486.png)

<br/>

<br/>

<br/>

ì´ë ‡ê²Œ í•´ì„œ ëŒ€íšŒë•ŒëŠ” í•˜ì§€ ëª»í–ˆë˜ ì‹œíë¦¬í‹° + OAtuh2ë¥¼ ì‚¬ìš©í•œ êµ¬ê¸€ ë¡œê·¸ì¸ì„ ì œëŒ€ë¡œ êµ¬í˜„í•´ ë³´ì•˜ë‹¤. ì±…ì—ì„œ ë‚˜ì™€ìˆëŠ” ë¶€ë¶„ì—ì„œ í˜¼ìì„œ ì¡°ê¸ˆ ë°œì „ë„ ì‹œì¼œë³´ì•˜ê³ , êµ‰ì¥íˆ ë¿Œë“¯í–ˆë‹¤.

ì •ë³´ ì œê³µ ë™ì˜ í›„ ì¶”ê°€ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ ë¡œê·¸ì¸ì„ ì§„í–‰í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œëŠ” ìë£Œê°€ ì •ë§ ì—†ì—ˆë‹¤. ê·¸ë˜ì„œ ëŒ€íšŒ ì¤€ë¹„ ë‹¹ì‹œ ë„ˆë¬´ í˜ë“¤ì—ˆêµ¬, ê²°êµ­ ì™„ë£Œí•˜ì§€ ëª»í–ˆë‹¤. í•˜ì§€ë§Œ ì§„ì§œ ì±…ì„ ë³´ê³  ì¡°ê¸ˆì”© ê³µë¶€í•˜ë©´ì„œ ì–´ëŠì •ë„ ì´í•´í•˜ê³  ì‚¬ìš©í•˜ë‹ˆ í›¨ì”¬ ìˆ˜ì›”í–ˆë‹¤. 

ë‚˜ì™€ê°™ì´ íšŒì›ê°€ì…ì„ êµ¬í˜„í•˜ê³  ì‹¶ì€ ì‚¬ëŒë“¤ì—ê²Œ ì¡°ê¸ˆ ë„ì›€ì´ ëìœ¼ë©´ ì¢‹ê² ë‹¤.

<br/>

### ğŸ“” Reference

##### ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ AWSë¡œ í˜¼ì êµ¬í˜„í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤ 124~161P

[SpringSecurityì‚¬ìš©ì¤‘ ê³„ì •ì •ë³´ê°€ updateë˜ì—ˆì„ë•Œ ê¶Œí•œì„ ë‹¤ì‹œë¡œë“œí•˜ëŠ” ë°©ë²•.](https://taesan94.tistory.com/135)