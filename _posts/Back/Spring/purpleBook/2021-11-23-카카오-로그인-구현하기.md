---
title:  "ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ êµ¬í˜„í•˜ê¸°"
excerpt: "ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ AWSë¡œ í˜¼ì êµ¬í˜„í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤ 4-4"
date:   2021-11-23 18:36:00 
header:
  teaser: /assets/images/spring.png

categories: purpleBook
tags:
  - Java
  - Spring
last_modified_at: 2021-11-23T18:36:00


---

<br/>

<br/>

## ì¹´ì¹´ì˜¤ êµ¬í˜„í•˜ê¸°

[ì¹´ì¹´ì˜¤ ê°œë°œì í˜ì´ì§€](https://developers.kakao.com/console/app)ë¡œ ì´ë™í•˜ì.

![image-20211123193815385](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123193815385.png)

[ì• í”Œë¦¬ì¼€ì´ì…˜ ì¶”ê°€í•˜ê¸°] ë²„íŠ¼ì„ ëˆ„ë¥´ì

<br/>

![image-20211123194043571](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123194043571.png)



##### ë¨¼ê°€ í—ˆìš©ë˜ì§€ ì•ŠëŠ” ì´ë¦„ì´ ì°¸ ë§ì•˜ë‹¤ :(

<br/>

![image-20211123194153896](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123194153896.png)

##### í´ë¦­

<br/>

![image-20211123194216705](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123194216705.png)

##### ì¢Œì¸¡ ì‚¬ì´ë“œë°”ì˜ [ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸]ì„ í´ë¦­í•˜ì.

<br/>

![image-20211123194258080](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123194258080.png)

![image-20211123194308594](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123194308594.png)

![image-20211123194321203](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123194321203.png)

<br/>

![image-20211123194404160](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123194404160.png)

##### http://localhost:8080/login/oauth2/code/kakao ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ URIë¥¼ ë“±ë¡í•˜ì.

<br/>

### ë™ì˜í•­ëª© ì„¤ì •

![image-20211123194517691](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123194517691.png)

![image-20211123194459468](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123194459468.png)

##### ë‹‰ë„¤ì„ê³¼ í”„ë¡œí•„ ì‚¬ì§„ë§Œ í•„ìˆ˜ ë™ì˜ë¥¼ í•˜ê³  ì§„í–‰í•˜ê² ë‹¤.

<br/>

### API í™•ì¸

ì•±ì„¤ì • -> ìš”ì•½ ì •ë³´ë¡œ ì´ë™í•˜ì

![image-20211123194739762](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123194739762.png)

REST APIí‚¤ê°€ ì´ì „ì— í–ˆë˜ ClientIdì´ë‹¤.

<br/>

#### [ì„ íƒ] ì‹œí¬ë¦¿ í‚¤ ë°œê¸‰

ì œí’ˆ ì„¤ì • -> ë³´ì•ˆìœ¼ë¡œ ì´ë™

![image-20211123194909993](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123194909993.png)

<br/>

<br/>

### ì‹œíë¦¬í‹° ì„¤ì •í•˜ê¸°

[ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ì¸ API](https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api) ë¥¼ ë³´ê³  ì°¸ê³ í•˜ì.

#### application-oauth.propertuies

```properties

spring.security.oauth2.client.registration.kakao.client-id=REST API í‚¤
spring.security.oauth2.client.registration.kakao.client-secret=ì‹œí¬ë¦¿ í‚¤
spring.security.oauth2.client.registration.kakao.redirect-uri=http://localhost:8080/login/oauth2/code/kakao

#ì¤‘ìš”!!
spring.security.oauth2.client.registration.kakao.client-authentication-method=POST 

spring.security.oauth2.client.registration.kakao.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.kakao.scope=profile_nickname,profile_image
spring.security.oauth2.client.registration.kakao.client-name=Kakao

spring.security.oauth2.client.provider.kakao.authorization-uri=https://kauth.kakao.com/oauth/authorize
spring.security.oauth2.client.provider.kakao.token-uri=https://kauth.kakao.com/oauth/token
spring.security.oauth2.client.provider.kakao.user-info-uri=https://kapi.kakao.com/v2/user/me
spring.security.oauth2.client.provider.kakao.user-name-attribute=id

```

##### spring.security.oauth2.client.registration.kakao.client-authentication-method=POST 

- ì¹´ì¹´ì˜¤ëŠ” ë‹¤ë¥¸ apiì™€ ë‹¤ë¥´ê²Œ ìœ„ ì½”ë“œê°€ í•„ìš”í•˜ë‹¤.
- ![image-20211123200636180](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123200636180.png)



<br/>

#### OAuthAttributes ì¶”ê°€

```java
package web.purplebook.config.auth.dto;

import lombok.Builder;
import lombok.Getter;
import web.purplebook.domain.user.Role;
import web.purplebook.domain.user.User;

import java.util.Map;

@Getter
public class OAuthAttributes {

    private Map<String, Object> attributes;
    private String nameAttributeKey;//OAuth2 ë¡œê·¸ì¸ ì§„í–‰ ì‹œ í‚¤ê°€ ë˜ëŠ” í•„ë“œê°’, Primary Keyì™€ ê°™ì€ ì˜ë¯¸.
    private String name;
    private String username;
    private String email;
    private String picture;

    private static final String NAVER="naver";
    private static final String NAVER_NAME_ATTRIBUTE_KEY="id";
    private static final String KAKAO="kakao";


    @Builder
    public OAuthAttributes(Map<String, Object> attributes, String nameAttributeKey, String name, String username, String email, String picture) {
        this.attributes = attributes;
        this.nameAttributeKey = nameAttributeKey;
        this.name = name;
        this.username = username;
        this.email = email;
        this.picture = picture;
    }

    public static OAuthAttributes of(String registrationId, String userNameAttributeName, Map<String, Object> attributes) {
        if (NAVER.equals(registrationId)) {
            return ofNaver(NAVER_NAME_ATTRIBUTE_KEY, attributes);
        }
        if (KAKAO.equals(registrationId)){
            return ofKakao(userNameAttributeName,attributes);
        }

        return ofGoogle(userNameAttributeName, attributes);
    }

    private static OAuthAttributes ofKakao(String userNameAttributeName, Map<String, Object> attributes) {
        // kakaoëŠ” kakao_accountì— ìœ ì €ì •ë³´ê°€ ìˆë‹¤. (email)
        Map<String, Object> kakaoAccount = (Map<String, Object>)attributes.get("kakao_account");
        // kakao_accountì•ˆì— ë˜ profileì´ë¼ëŠ” JSONê°ì²´ê°€ ìˆë‹¤. (nickname, profile_image)
        Map<String, Object> kakaoProfile = (Map<String, Object>)kakaoAccount.get("profile");

        return OAuthAttributes.builder()
                .name((String) kakaoProfile.get("nickname"))
                .picture((String) kakaoProfile.get("profile_image_url"))
                .attributes(attributes)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }


    public static OAuthAttributes ofGoogle(String userNameAttributeName, Map<String, Object> attributes) {
        return OAuthAttributes.builder()
                .name((String) attributes.get("name"))
                .email((String) attributes.get("email"))
                .picture((String) attributes.get("picture"))
                .attributes(attributes)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }

    public static OAuthAttributes ofNaver(String userNameAttributeName, Map<String, Object> attributes) {
        Map<String, Object> response = (Map<String, Object>) attributes.get("response");

        return OAuthAttributes.builder()
                .name((String) response.get("name"))
                .email((String) response.get("email"))
                .picture((String) response.get("profile_image"))
                .attributes(response)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }



    public User toEntity(){//domainì˜ USER, ì•„ì§ íšŒì›ê°€ì…ì€ ì•ˆ í•˜ê³  ì†Œì…œ ë¡œê·¸ì¸ ë™ì˜ë§Œ í•œ ìƒíƒœ
        return User.builder()
                .name(name)
                .email(email)
                .picture(picture)
                .role(Role.GUEST)
                .build();
    }


}
```

<br/>

#### index.htmlì— ì¶”ê°€

```html
<a href="/oauth2/authorization/kakao"class="btn btn-light active" role="button" th:unless="${not #strings.isEmpty(username)}">Kakao Login</a>
```

<br/>

<br/>

<br/>

### í™•ì¸í•´ë³´ì

![image-20211123201231007](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123201231007.png)

![image-20211123201239952](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123201239952.png)

![image-20211123201248952](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123201248952.png)

![image-20211123201258962](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123201258962.png)

<br/>

#### ì„±ê³µì´ë‹¤!!!

<br/>

<br/>

### ğŸ“” Reference

[\[Spring] ìŠ¤í”„ë§ìœ¼ë¡œ OAuth2 ë¡œê·¸ì¸ êµ¬í˜„í•˜ê¸°3 - ì¹´ì¹´ì˜¤](https://loosie.tistory.com/302)

[ì¹´ì¹´ì˜¤í†¡ ë¡œê·¸ì¸ API, REST APIì‚¬ìš©ë²•](https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api#req-user-info)