---
title:  "ë„¤ì´ë²„ ë¡œê·¸ì¸ êµ¬í˜„í•˜ê¸°"
excerpt: "ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ AWSë¡œ í˜¼ì êµ¬í˜„í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤ 4-3"
date:   2021-11-23 18:16:00 
header:
  teaser: /assets/images/spring.png

categories: purpleBook
tags:
  - Java
  - Spring
last_modified_at: 2021-11-23T18:16:00

---

<br/>

<br/>

## ë„¤ì´ë²„ ë¡œê·¸ì¸ êµ¬í˜„í•˜ê¸°

[https://developers.naver.com/apps/#/wizard/register](https://developers.naver.com/apps/#/wizard/register)ì´ê³³ìœ¼ë¡œ ì´ë™í•˜ì.

ì•½ê´€ ë™ì˜ë¥¼ í•´ ì£¼ë©´ ë‹¤ìŒê³¼ ê°™ì€ í™”ë©´ì´ ëœ° í…ë°, íšŒì‚¬ ì´ë¦„ì€ ì²´í¬ë§Œ í•˜ê³  ë„˜ì–´ê°€ì£¼ì

![image-20211123183353100](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123183353100.png)

<br/>

### ì• í”Œë¦¬ì¼€ì´ì…˜ ë“±ë¡

![image-20211123183614353](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123183614353.png)

ì´ë¦„ì€ ìì‹ ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„ì„ ë“±ë¡í•´ì£¼ì.

<br/>

![image-20211123183643231](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123183643231.png)

ì‚¬ìš© APIëŠ” ë”°ë¡œ ì„¤ëª…ì´ í•„ìš” ì—†ì„ ê±° ê°™ë‹¤.

<br/>

![image-20211123183724706](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123183724706.png)

í™˜ê²½ì„ PCì›¹, ì„œë¹„ìŠ¤ URLì€ localhost:8080,

Callback URLì€ êµ¬ê¸€ì—ì„œì˜ ë¦¬ë””ë ‰ì…˜ URLê³¼ ê°™ì€ ì—­í• ì„ í•œë‹¤. ì—¬ê¸°ì„œëŠ” 

> http://localhost:8080/login/oauth2/code/naver 

ë¡œ ë“±ë¡í•œë‹¤.

<br/>

![image-20211123183859857](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123183859857.png)

ë“±ë¡ì„ ì™„ë£Œí•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ClientIDì™€ Client Secretì´ ìƒì„±ë˜ëŠ”ë°, ì´ë¥¼ application.oauth.propertiesì— ë“±ë¡í•œë‹¤.

##### ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ëŠ” ë„¤ì´ë²„ APIë¥¼ ì§€ì›í•´ì£¼ì§€ ì•Šê¸° ë•Œë¬¸ì—, ì „ë¶€ ìˆ˜ë™ìœ¼ë¡œ ë“±ë¡í•´ì•¼ í•œë‹¤.

ë“±ë¡í•  ë•Œ ì°¸ê³ í•˜ì

[ë„¤ì´ë²„ ë¡œê·¸ì¸ API ê°€ì´ë“œ](https://developers.naver.com/docs/login/devguide/devguide.md#%EB%84%A4%EC%9D%B4%EB%B2%84%20%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EA%B0%9C%EB%B0%9C%EA%B0%80%EC%9D%B4%EB%93%9C)

<br/>

#### application.oauth.properties

```properties
spring.security.oauth2.client.registration.naver.client-id=í´ë¼Id
spring.security.oauth2.client.registration.naver.client-secret=í´ë¼ Secret
spring.security.oauth2.client.registration.naver.redirect-uri=http://localhost:8080/login/oauth2/code/naver
spring.security.oauth2.client.registration.naver.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.naver.scope=name,email,profile_image
spring.security.oauth2.client.registration.naver.client-name=Naver

spring.security.oauth2.client.provider.naver.authorization-uri=https://nid.naver.com/oauth2.0/authorize
spring.security.oauth2.client.provider.naver.token-uri=https://nid.naver.com/oauth2.0/token
spring.security.oauth2.client.provider.naver.user-info-uri=https://openapi.naver.com/v1/nid/me
spring.security.oauth2.client.provider.naver.user-name-attribute=response
```

spring.security.oauth2.client.provider.naver.user-name-attribute=response

- ê¸°ì¤€ì´ ë˜ëŠ” user_nameì˜ ì´ë¦„ì„ ë„¤ì´ë²„ì—ì„œëŠ” responseë¡œ í•´ì•¼í•œë‹¤.
- ì´ìœ ëŠ” ë„¤ì´ë²„ ì˜¤í”ˆ APIì˜ ë¡œê·¸ì¸ íšŒì› ê²°ê³¼ ë•Œë¬¸ì¸ë‹¤.

![image-20211123185030154](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123185030154.png)

ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œëŠ” í•˜ìœ„ í•„ë“œë¥¼ ëª…ì‹œí•  ìˆ˜ ì—†ë‹¤. ìµœìƒìœ„ í•„ë“œë“¤ë§Œ user_nameìœ¼ë¡œ ì§€ì • ê°€ëŠ¥í•˜ë‹¤. í•˜ì§€ë§Œ ë„¤ì´ë²„ì˜ ì‘ë‹µê°’ ìµœìƒìœ„ í•„ë“œëŠ” resultcode, message, responseì´ë‹¤. ì´ëŸ¬í•œ ì´ìœ ë¡œ responseë¥¼ user_nameìœ¼ë¡œ ì§€ì •í•œ í›„, responseì˜ idë¥¼ user_nameìœ¼ë¡œ ì§€ì •í•˜ê² ë‹¤

<br/>

<br/>

#### OAuthAttributesì— ì¶”ê°€

```java
package web.purplebook.config.auth.dto;

import lombok.Builder;
import lombok.Getter;
import web.purplebook.domain.user.Role;
import web.purplebook.domain.user.User;

import java.util.Map;

@Getter
public class OAuthAttributes {

    private Map<String, Object> attributes;
    private String nameAttributeKey;//OAuth2 ë¡œê·¸ì¸ ì§„í–‰ ì‹œ í‚¤ê°€ ë˜ëŠ” í•„ë“œê°’, Primary Keyì™€ ê°™ì€ ì˜ë¯¸.
    private String name;
    private String username;
    private String email;
    private String picture;

    private static final String NAVER="naver";
    private static final String NAVER_NAME_ATTRIBUTE_KEY="id";

    @Builder
    public OAuthAttributes(Map<String, Object> attributes, String nameAttributeKey, String name, String username, String email, String picture) {
        this.attributes = attributes;
        this.nameAttributeKey = nameAttributeKey;
        this.name = name;
        this.username = username;
        this.email = email;
        this.picture = picture;
    }

    public static OAuthAttributes of(String registrationId, String userNameAttributeName, Map<String, Object> attributes) {
        if (NAVER.equals(registrationId)) {
            return ofNaver(NAVER_NAME_ATTRIBUTE_KEY, attributes);
        }

        return ofGoogle(userNameAttributeName, attributes);
    }


    public static OAuthAttributes ofGoogle(String userNameAttributeName, Map<String, Object> attributes) {
        return OAuthAttributes.builder()
                .name((String) attributes.get("name"))
                .email((String) attributes.get("email"))
                .picture((String) attributes.get("picture"))
                .attributes(attributes)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }

    public static OAuthAttributes ofNaver(String userNameAttributeName, Map<String, Object> attributes) {
        Map<String, Object> response = (Map<String, Object>) attributes.get("response");
        
        return OAuthAttributes.builder()
                .name((String) response.get("name"))
                .email((String) response.get("email"))
                .picture((String) response.get("profile_image"))
                .attributes(response)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }



    public User toEntity(){//domainì˜ USER, ì•„ì§ íšŒì›ê°€ì…ì€ ì•ˆ í•˜ê³  ì†Œì…œ ë¡œê·¸ì¸ ë™ì˜ë§Œ í•œ ìƒíƒœ
        return User.builder()
                .name(name)
                .email(email)
                .picture(picture)
                .role(Role.GUEST)
                .build();
    }


}
```

<br/>

##### index.htmlì— ì¶”ê°€

```html
<a href="/oauth2/authorization/naver"class="btn btn-secondary active" role="button" th:unless="${not #strings.isEmpty(username)}">Naver Login</a>
```

ì „ì²´ ì½”ë“œ

```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header">
    <title>Hello</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>

<body>
    <h1>ìŠ¤í”„ë§ ë¶€íŠ¸ë¡œ ì‹œì‘í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤</h1>
    <div class="col-md-12">
        <div class="row">
            <div class="col-md-6">
                <a href="/posts/save" role="button" class="btn btn-primary">ê¸€ë“±ë¡</a>
            </div>
        </div>
        <br/>
        <!-- ë¡œê·¸ì¸ ê¸°ëŠ¥ -->
        <span id="user" th:if="${not #strings.isEmpty(username)}" th:text="${username}"></span>
        <a href="/logout"class="btn btn-info active" role="button" th:if="${not #strings.isEmpty(username)}">Logout</a>

        <a href="/oauth2/authorization/google"class="btn btn-success active" role="button" th:unless="${not #strings.isEmpty(username)}">Google Login</a>
        
        <!-- ë„¤ì´ë²„ ì¶”ê°€ -->
        <a href="/oauth2/authorization/naver"class="btn btn-secondary active" role="button" th:unless="${not #strings.isEmpty(username)}">Naver Login</a>

        <!-- ëª©ë¡ ì¶œë ¥ ì˜ì—­ -->
        <table class="table table-horizontal table-bordered">
            <thead class="thead-strong">
            <tr>
                <th>ê²Œì‹œê¸€ë²ˆí˜¸</th>
                <th>ì œëª©</th>
                <th>ì‘ì„±ì</th>
                <th>ìµœì¢…ìˆ˜ì •ì¼</th>
            </tr>
            </thead>

            <tbody id="tbody">
                <tr th:each="post : ${posts}">
                    <td th:text="${post.id}"></td>
                    <td>
                        <a href="#" th:href="@{/posts/update/{id} (id=${post.id})}" th:text="${post.title}">ìˆ˜ì •</a>
                    </td>
                    <td th:text="${post.author}"></td>
                    <td th:text="${post.modifiedDate}"></td>
                    <td>
                        <a href="#" th:href="@{/posts/update/{id} (id=${post.id})}" class="btn btn-primary" role="button">ìˆ˜ì •</a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div th:replace="fragments/footer :: footer" />
</body>
</html>
```

##### /oauth2/authorization/naver

- ë„¤ì´ë²„ ë¡œê·¸ì¸ URLì€ application-oauth.propertiesì— ë“±ë¡í•œ redirect-uri ê°’ì— ë§ì¶° ìë™ìœ¼ë¡œ ë“±ë¡ëœë‹¤.

<br/>

<br/>

### ì‹¤í–‰í•´ë³´ì

![image-20211123190522729](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123190522729.png)



![image-20211123192914150](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123192914150.png)

![image-20211123192922517](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123192922517.png)

![image-20211123192932722](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123192932722.png)

ë‹¤ ì˜ ëœë‹¤!!!!!

<br/>

#### ê·¼ë° ë¬¸ì œì ì´ í•˜ë‚˜ ìˆë‹¤.

í•„ìˆ˜ ì œê³µí•­ëª©ì„ ì²´í¬ ì•ˆ í•˜ê³  ë™ì˜í•˜ëŠ” ê²½ìš°ì—ëŠ”, ë”°ë¡œ í•„ìš”í•œ ê°’ë“¤ì„ ì…ë ¥ë°›ì•„ì•¼ í•œë‹¤..!!

ê·¸ê±´ ì¶”ê°€ ì •ë³´ì—ì„œ ì•Œì•„ì„œ í•  ìˆ˜ ìˆìœ¼ë‹ˆê¹Œ ì¼ë‹¨ ë„˜ì–´ê°€ê³  ë‹¤ìŒì€ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì„ ì§„í–‰í•˜ê² ë‹¤.

<br/>

<br/>

### ğŸ“” Reference

##### ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ AWSë¡œ í˜¼ì êµ¬í˜„í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤ 124~161P
