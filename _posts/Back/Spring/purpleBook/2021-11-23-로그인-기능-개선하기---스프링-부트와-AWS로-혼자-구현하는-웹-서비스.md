---
title:  "ë¡œê·¸ì¸ ê¸°ëŠ¥ ê°œì„ í•˜ê¸° - ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ AWSë¡œ í˜¼ì êµ¬í˜„í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤"
excerpt: "ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ AWSë¡œ í˜¼ì êµ¬í˜„í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤ 4-2"
date:   2021-11-23 15:16:00 
header:
  teaser: /assets/images/spring.png

categories: purpleBook
tags:
  - Java
  - Spring
last_modified_at: 2021-11-23T15:16:00



---

<br/>

<br/>

ì‚¬ì‹¤ í•œ ì±•í„°ì— í¬í•¨ëœ ë‚´ìš©ì¸ë°, ê¸€ì´ ë„ˆë¬´ ê¸¸ì–´ì ¸ì„œ ì´ë ‡ê²Œ ë‚˜ëˆˆë‹¤!

## ì–´ë…¸í…Œì´ì…˜ ê¸°ë°˜ìœ¼ë¡œ ê°œì„ í•˜ê¸°

ì´ì „ ê¸€ì—ì„œ ë§Œë“¤ì—ˆë˜ êµ¬ê¸€ì„ í†µí•œ ë¡œê·¸ì¸ ë°©ë²•ì—ì„œ ê°œì„ í•  ë¶€ë¶„ì´ ë¬´ì—‡ì´ ìˆì„ê¹Œ?

IndexControllerì—ì„œ ì„¸ì…˜ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ì´ë‹¤.

```java
SessionUser user = (SessionUser) httpSession.getAttribute("user");
```

##### indexë©”ì†Œë“œ ì™¸ì—ë„ ë‹¤ë¥¸ ì»¨íŠ¸ë¡¤ëŸ¬ì™€ ì„¸ì…˜ê°’ì´ í•„ìš”í•˜ë©´ ê·¸ë•Œë§ˆë‹¤ ì§ì ‘ ì„¸ì…˜ì—ì„œ ê°’ì„ ê°€ì ¸ì™€ì•¼ í•œë‹¤.

##### ì´ ë¶€ë¶„ì„ ì–´ë…¸í…Œì´ì…˜ì„ í™œìš©í•˜ì—¬ ë°”ê¿”ë³´ì.

<br/>

#### LoginUser ìƒì„±

```java
package web.purplebook.config.auth;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
public @interface LoginUser {
}
```

##### @Target(ElementType.PARAMETER)

- ì´ ì–´ë…¸í…Œì´ì…˜ì´ ìƒì„±(ì ìš©)ë  ìˆ˜ ìˆëŠ” ìœ„ì¹˜ë¥¼ ì§€ì •í•œë‹¤.
- PARAMETERë¡œ ì§€ì •í–ˆìœ¼ë‹ˆ ë©”ì†Œë“œì˜ íŒŒë¼ë¯¸í„°ë¡œ ì„ ì–¸ëœ ê°ì²´ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

<br/>

<br/>

#### LogInUserArgumentResolver

```java
package web.purplebook.config.auth;

import lombok.RequiredArgsConstructor;
import org.springframework.core.MethodParameter;
import org.springframework.stereotype.Component;
import org.springframework.web.bind.support.WebDataBinderFactory;
import org.springframework.web.context.request.NativeWebRequest;
import org.springframework.web.method.support.HandlerMethodArgumentResolver;
import org.springframework.web.method.support.ModelAndViewContainer;
import web.purplebook.config.auth.dto.SessionUser;

import javax.servlet.http.HttpSession;

@RequiredArgsConstructor
@Component
public class LogInUserArgumentResolver implements HandlerMethodArgumentResolver {
    
    private final HttpSession httpSession;

    @Override
    public boolean supportsParameter(MethodParameter parameter) {
        boolean isLoginUserAnnotation = parameter.hasParameterAnnotation(LoginUser.class);
        boolean isUserClass = SessionUser.class.isAssignableFrom(parameter.getParameterType());

        return isLoginUserAnnotation && isUserClass;
    }

    @Override
    public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception {

        return httpSession.getAttribute("user");
    }
}
```

<br/>

<br/>

#### WebConfig

```java
package web.purplebook.config;

import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.method.support.HandlerMethodArgumentResolver;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
import web.purplebook.config.auth.LogInUserArgumentResolver;

import java.util.List;

@RequiredArgsConstructor
@Configuration
public class WebConfig implements WebMvcConfigurer {
    private final LogInUserArgumentResolver logInUserArgumentResolver;

    @Override
    public void addArgumentResolvers(List<HandlerMethodArgumentResolver> resolvers) {
        resolvers.add(logInUserArgumentResolver);
    }
}
```

<br/>

<br/>

ì´ëŸ¬ë©´ ì–´ë…¸í…Œì´ì…˜ ì ìš©ì´ ëë‚¬ë‹¤.

##### ì´ì œ ì ìš©í•´ë³´ì

<br/>

#### IndexController ìˆ˜ì •

```java
package web.purplebook.web;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import web.purplebook.config.auth.LoginUser;
import web.purplebook.config.auth.dto.SessionUser;
import web.purplebook.service.posts.PostsService;
import web.purplebook.web.dto.PostsResponseDto;

@Controller
@RequiredArgsConstructor
public class IndexController {

    private final PostsService postsService;

    @GetMapping("/")
    public String index(Model model, @LoginUser SessionUser user){//ì¶”ê°€
        model.addAttribute("posts", postsService.findAllDesc());
        
        if(user != null && user.getUsername() != null){
            model.addAttribute("username", user.getName());
        }

        return "index";
    }

    @GetMapping("/posts/save")
    public String postsSave(){
        return "posts-save";
    }


    @GetMapping("/posts/update/{id}")
    public String postsUpdate(@PathVariable("id")Long id, Model model) {
        PostsResponseDto dto = postsService.findById(id);
        model.addAttribute("post",dto);
        return "posts-update";
    }

}
```

<br/>

<br/>

#### CustomOAuth2SignUpController ìˆ˜ì •

```java
package web.purplebook.web;

import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.ResponseBody;
import web.purplebook.config.auth.LoginUser;
import web.purplebook.config.auth.dto.OAuth2SignUpDto;
import web.purplebook.config.auth.dto.SessionUser;
import web.purplebook.domain.user.User;
import web.purplebook.repository.UserRepository;

import javax.servlet.http.HttpSession;
import java.util.ArrayList;
import java.util.List;

@Controller
@RequiredArgsConstructor
public class CustomOAuth2SignUpController {

    private final HttpSession httpSession;
    private final UserRepository userRepository;

    @GetMapping("/addform")
    public String addForm(Model model, @LoginUser SessionUser user){
        if(user.getUsername() != null){
            model.addAttribute("username", user.getName());
            return "index";//ì´ë¯¸ íšŒì›ê°€ì… í•œ ì‚¬ëŒì´ë¼ë©´ ë©”ì¸ í˜ì´ì§€ë¡œ
        }
        else {
            return "/add-form";
        }
    }



    //ì¶”ê°€ ì…ë ¥
    @PostMapping("/signUp")
    @ResponseBody
    @Transactional
    public Long signUp(@RequestBody OAuth2SignUpDto oAuth2SignUpDto, @LoginUser SessionUser user){
        Long id = user.getId();

        User user1 = userRepository.findById(id).orElse(null);
        user1.googleSignUp(oAuth2SignUpDto.getUsername());//username ë“±ë¡


        updateRole(user1);

        httpSession.setAttribute("user", new SessionUser(user1));
        return 0L;
    }

    private void updateRole(User user) {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        List<GrantedAuthority> updatedAuthorities = new ArrayList<>();
        updatedAuthorities.add(new SimpleGrantedAuthority(user.getRoleKey()));
        Authentication newAuth = new UsernamePasswordAuthenticationToken(auth.getPrincipal(), auth.getCredentials(), updatedAuthorities);
        SecurityContextHolder.getContext().setAuthentication(newAuth);
    }
}
```

<br/>

<br/>

<br/>

## ì„¸ì…˜ ì €ì¥ì†Œë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©í•˜ê¸°

ì‚¬ì‹¤ í•„ìëŠ” í”„ë¡ íŠ¸ì™€ ë°±ì„ ë‚˜ëˆ„ì–´ì„œ Rest API ë°©ì‹ìœ¼ë¡œ í†µì‹ í•˜ëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë§Œë“¤ê³  ì‹¶ì—ˆë‹¤.

ê·¸ë˜ì„œ ì‚¬ì‹¤ ì•„ê¹Œ ë¡œê·¸ì¸ë¶€í„° ì„¸ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ë¶€ë¶„ì„ ì—†ì• ê³  JWTë¥¼ ì‚¬ìš©í•˜ì—¬ Statelessí•˜ê²Œ ì •ë³´ë¥¼ ì£¼ê³ ë°›ê³  ì‹¶ì—ˆìœ¼ë‚˜, ì•„ì§ ë‚´ê°€ í”„ë¡ íŠ¸ë¥¼ ë‹¤ë£° ì¤„ ëª¨ë¥¸ë‹¤ ã… ã… 

ì—¬ê¸°ì„œ ì ì‹œ ë©ˆì¶”ê³  í”„ë¡ íŠ¸ë¥¼ ê³µë¶€í•œ í›„ ë‹¤ì‹œ ì™€ì„œ ë§ˆë¬´ë¦¬ í•˜ê¸°ì—ëŠ” ì‹œê°„ë„ ë„ˆë¬´ ì˜¤ë˜ê±¸ë¦¬ê³  ì—¬ëŸ¬ëª¨ë¡œ ë³„ë¡œë¼ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤.

ê·¸ë˜ì„œ ì¼ë‹¨ì€ ì´ ì±…ì— ë‚˜ì˜¨ ë°©ì‹ëŒ€ë¡œ ì„¸ì…˜ì„ ì‚¬ìš©í•  ê²ƒì´ë‹¤.

ê·¸ëŸ¬ë‚˜ ì´í›„ ì´ ì±…ì„ ëê¹Œì§€ ë‹¤ ë”°ë¼ í•œ ë‹¤ìŒì—ëŠ” í† í°ì„ ì‚¬ìš©í•´ì„œ REST API ë°©ì‹ìœ¼ë¡œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•˜ë„ë¡ ì½”ë“œë¥¼ ë°”ê¿”ë³¼ ê²ƒì´ë‹¤.

ìš°ì„ ì„ ì„¸ì…˜ì„ ì‚¬ìš©í•˜ë©´ì„œ ì½”ë“œë¥¼ ì‘ì„±í•´ë³´ì.

<br/>

<br/>

ìš°ë¦¬ê°€ í˜„ì¬ê¹Œì§€ ë§Œë“  ì„œë¹„ìŠ¤ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¬ì‹¤í–‰í•˜ë©´ ë¡œê·¸ì¸ì´ í’€ë¦°ë‹¤.

ì´ëŠ” ì„¸ì…˜ì´ ë‚´ì¥ í†°ì¼“ì˜ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ê¸° ë•Œë¬¸ì´ë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ ì„¸ì…˜ì€ ì‹¤í–‰ë˜ëŠ” WASì˜ ë©”ëª¨ë¦¬ì—ì„œ ì €ì¥ë˜ê³  í˜¸ì¶œëœë‹¤.

ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ë‹¤ ë³´ë‹ˆ ë‚´ì¥ í†°ìº£ì²˜ëŸ¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ ì‹¤í–‰ë˜ëŠ” êµ¬ì¡°ì—ì„  í•­ìƒ ì´ˆê¸°í™”ê°€ ëœë‹¤.

##### ì¦‰ ë°°í¬í•  ë•Œë§ˆë‹¤ í†°ìº£ì´ ì¬ì‹œì‘ë˜ëŠ” ê²ƒì´ë‹¤.

ì´ ì™¸ì—ë„ í•œ ê°€ì§€ ë¬¸ì œê°€ ë” ìˆëŠ”ë°, 2ëŒ€ ì´ìƒì˜ ì„œë²„ì—ì„œ ì„œë¹„ìŠ¤í•˜ê³  ìˆë‹¤ë©´ í†°ìº£ë§ˆë‹¤ ì„¸ì…˜ ë™ê¸°í™” ì„¤ì •ì„ í•´ì£¼ì–´ì•¼ í•œë‹¤.

ê·¸ë˜ì„œ ì‹¤ì œ í˜„ì—…ì—ì„œëŠ” ì„¸ì…˜ ì €ì¥ì†Œì— ëŒ€í•´ ë‹¤ìŒì˜ 3ê°€ì§€ì¤‘ í•œ ê°€ì§€ë¥¼ ì„ íƒí•œë‹¤.

(1) í†°ìº£ ì„¸ì…˜ì„ ì‚¬ìš©í•œë‹¤

- ì¼ë°˜ì ìœ¼ë¡œ ë³„ë‹¤ë¥¸ ì„¤ì •ì„ í•˜ì§€ ì•Šì„ ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ ì„ íƒë˜ëŠ” ë°©ì‹ì´ë‹¤.
- ì´ë ‡ê²Œ ë  ê²½ìš° í†°ìº£(WAS)ì— ì„¸ì…˜ì´ ì €ì¥ë˜ê¸° ë•Œë¬¸ì— 2ëŒ€ ì´ìƒì˜ WASê°€ êµ¬ë™ë˜ëŠ” í™˜ê²½ì—ì„œëŠ” í†°ìº£ë“¤ ê°„ì˜ ì„¸ì…˜ ê³µìœ ë¥¼ ìœ„í•œ ì¶”ê°€ ì„¤ì •ì´ í•„ìš”í•˜ë‹¤.

(2) MySQLê³¼ ê°™ì€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„¸ì…˜ ì €ì¥ì†Œë¡œ ì‚¬ìš©í•œë‹¤

- ì—¬ëŸ¬ WASê°„ì˜ ê³µìš© ì„¸ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•ì´ë‹¤.
- ë§ì€ ì„¤ì •ì´ í•„ìš” ì—†ì§€ë§Œ ê²°êµ­ ë¡œê·¸ì¸ ìš”ì²­ë§ˆë‹¤ DB IOê°€ ë°©ìƒí•˜ì—¬ ì„±ëŠ¥ìƒ ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
- ë³´í†µ ë¡œê·¸ì¸ ìš”ì²­ì´ ë§ì´ ì—†ëŠ” ë°±ì˜¤í”¼ìŠ¤, ì‚¬ë‚´ ì‹œìŠ¤í…œ ìš©ë„ì—ì„œ ì‚¬ìš©í•œë‹¤.

(3) Redis, Memcachedì™€ ê°™ì€ ë©”ëª¨ë¦¬ DBë¥¼ ì„¸ì…˜ ì €ì¥ì†Œë¡œ ì‚¬ìš©í•œë‹¤.

- B2C ì„œë¹„ìŠ¤ì—ì„œ ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ë‹¤.
- ì‹¤ì œ ì„œë¹„ìŠ¤ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” Embedded Redisì™€ ê°™ì€ ë°©ì‹ì´ ì•„ë‹Œ ì™¸ë¶€ ë©”ëª¨ë¦¬ ì„œë²„ê°€ í•„ìš”í•˜ë‹¤.

ì—¬ê¸°ì„œëŠ” ë‘ ë²ˆì§¸ ë°©ì‹ì¸ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„¸ì…˜ ì €ì¥ì†Œë¡œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì„ ì„ íƒí•˜ì—¬ ì§„í–‰í•˜ê² ë‹¤.

ì´ìœ ëŠ” ì„¤ì •ì´ ê°„ë‹¨í•˜ê³ , ì´í›„ ì„œë¹„ìŠ¤ë¥¼ ë°°í¬í•˜ëŠ” ê²½ìš°ë¥¼ ìƒê°í•´ ë³´ë©´, ë ˆë””ìŠ¤ì™€ ê°™ì€ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë³„ë„ë¡œ ì‚¬ìš©ë£Œë¥¼ ì§€ë¶ˆí•´ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

ì¼ë‹¨ì€ ë°ì´ë²„í…Œì´ìŠ¤ë¡œ ì²˜ë¦¬í•œ í›„ ì´í›„ ì„œë¹„ìŠ¤ê°€ ì»¤ì§„ë‹¤ë©´ ë©”ëª¨ë¦¬DBë¥¼ ê³ ë ¤í•´ë³´ì.

<br/>

<br/>

### Spring-session-jdbc ë“±ë¡

##### build.gradleì— ë‹¤ìŒê³¼ ê°™ì´ ì˜ì¡´ì„±ì„ ë“±ë¡í•œë‹¤.

```properties
implementation 'org.springframework.session:spring-session-jdbc'
```

<br/>

##### application.propertiesì— ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•œë‹¤.

```properties
spring.session.store-type=jdbc
```

<br/>

ì´í›„ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì—¬ ë¡œê·¸ì¸ ì§„í–‰ í›„, h2-consoleë¡œ ì ‘ì†í•´ë³´ì.

<br/>

![image-20211123181534494](https://raw.githubusercontent.com/ShinDongHun1/image_repo/main/img/image-20211123181534494.png)

ë‹¤ìŒê³¼ ê°™ì´ ì„¸ì…˜ì„ ìœ„í•œ í…Œì´ë¸” 2ê°œê°€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆë‹¤.

í˜„ì¬ëŠ” H2ì˜ ë©”ëª¨ë¦¬ DBë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¬ì‹œì‘ í•˜ë©´ ë¡œê·¸ì¸ì´ í’€ë¦°ë‹¤.

ê·¸ëŸ¬ë‚˜ ì´í›„ AWSë¡œ ë°°í¬í•˜ê²Œ ë˜ë©´ AWSì˜ ë°ì´í„°ë² ì´ìŠ¤ì¸ RDSë¥¼ ì‚¬ìš©í•  ê²ƒì´ê¸° ë•Œë¬¸ì— ì„¸ì…˜ì´ í’€ë¦¬ì§€ ì•ŠëŠ”ë‹¤.

<br/>

<br/>

##### ë‹¤ìŒ ê¸€ ë¶€í„°ëŠ” ë‚˜ë¨¸ì§€ ì†Œì…œ ë¡œê·¸ì¸ ë“±ì„ ì§„í–‰í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œë„ ì•Œì•„ë³´ì.

ì±…ì—ì„œëŠ” ë„¤ì´ë²„ë¥¼ í†µí•œ ë¡œê·¸ì¸ì´ ë§ˆì§€ë§‰ì´ë‹¤. ê·¸ëŸ¬ë‚˜ ë‚˜ëŠ” ì´í›„ ì§„í–‰í•  ì–´ë–¤ í”„ë¡œì íŠ¸ë˜ì§€ ì†Œì…œ ë¡œê·¸ì¸ì„ ì‚¬ìš©í•  ê²ƒ ê°™ê¸° ë•Œë¬¸ì—, ë¯¸ë¦¬ ëª¨ë“  ì†Œì…œ ë¡œê·¸ì¸ì„ ë§Œë“¤ì–´ë‘ê³  ì‹¶ë‹¤.

ì§€ê¸ˆ ìƒê°í•˜ëŠ” ì†Œì…œ ë¡œê·¸ì¸ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

- êµ¬ê¸€ (ì™„ë£Œ)
- ë„¤ì´ë²„
- ì¹´ì¹´ì˜¤
- í˜ì´ìŠ¤ë¶
- ê¹ƒí—ˆë¸Œ
- ì• í”Œ
- ë¼ì¸

<br/>

### ğŸ“” Reference

##### ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ AWSë¡œ í˜¼ì êµ¬í˜„í•˜ëŠ” ì›¹ ì„œë¹„ìŠ¤ 124~161P

